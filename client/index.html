<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AetherWave Studio - All Intelligence is Welcome Here</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
   /*:root {
    --aetherwave-pink: #ff2ea6;
    --aetherwave-purple: #8b5cf6;
    --dark-bg: #0d0b15;
    --card-bg: #1a1625;
    --text-primary: #e9e8ff;
    --text-muted: #b7b3d9;
    --border-color: #2d2640;
    } */
        :root {
    --aetherwave-pink: #ff2ea6;
    --aetherwave-purple: #8b5cf6;
    --dark-bg: #0d0b15;
    --card-bg: #1a1625;
    --text-primary: #e9e8ff;
    --text-muted: #b7b3d9;
    --border-color: #2d2640;
    }


    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--dark-bg);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    }

    /* Animated Background */
    .bg-container {
    position: fixed;
    inset: 0;
    z-index: 0;
    overflow: hidden;
    background: radial-gradient(ellipse at 20% 30%, rgba(139, 92, 246, 0.15), transparent 50%),
    radial-gradient(ellipse at 80% 70%, rgba(255, 46, 166, 0.12), transparent 50%);
    }

    .bg-grid {
    position: absolute;
    inset: 0;
    background-image:
    linear-gradient(var(--border-color) 1px, transparent 1px),
    linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.3;
    animation: gridMove 20s linear infinite;
    }

    @keyframes gridMove {
    0% { transform: translate(0, 0); }
    100% { transform: translate(60px, 60px); }
    }

    .orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.4;
    animation: float 15s ease-in-out infinite;
    }

    .orb-1 {
    width: 400px;
    height: 400px;
    background: var(--aetherwave-pink);
    top: 10%;
    left: 10%;
    animation-delay: 0s;
    }

    .orb-2 {
    width: 300px;
    height: 300px;
    background: var(--aetherwave-purple);
    bottom: 20%;
    right: 15%;
    animation-delay: 5s;
    }

    @keyframes float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -30px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    /* Header */
    header {
    position: relative;
    z-index: 10;
    padding: .5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    backdrop-filter: blur(12px);
    background: rgba(13, 11, 21, 0.8);
    }

    .logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
    }

    .logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    }
        .logo-icon2 {
    width: 75px;
    height: 75px;
    /*background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));*/
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    }

    nav {
    display: flex;
    gap: 2rem;
    align-items: center;
    }

    nav a {
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.95rem;
    transition: color 0.2s;
    }

    nav a:hover {
    color: var(--text-primary);
    }

    .nav-btn {
    padding: 0.5rem 1.25rem;
    background: var(--aetherwave-pink);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    }

    .nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 46, 166, 0.4);
    }

    /* Main Content */
    main {
    position: relative;
    z-index: 1;
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    max-width: 1600px;
    margin: 0 auto;
    width: 100%;
    min-height: 0;
    }

    .panels-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: auto 1fr;
    gap: 1.5rem;
    flex: 1;
    min-height: 0;
    position: relative;
    }

    .hero-text {
    grid-column: 2 / 3;
    grid-row: 1 / 2;
    text-align: center;
    animation: fadeInUp 0.8s ease-out;
    background: linear-gradient(135deg, rgba(13, 11, 21, 0.98), rgba(20, 15, 35, 0.98));
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 1.75rem 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    }
    
    .panel-music {
      grid-column: 1 / 2;
      grid-row: 1 / 3;
    }
    
    .panel-chat {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
    }
    
    .panel-media {
      grid-column: 3 / 4;
      grid-row: 1 / 3;
    }

    @keyframes fadeInUp {
    from {
    opacity: 0;
    transform: translateY(20px);
    }
    to {
    opacity: 1;
    transform: translateY(0);
    }
    }

    h1 {
    font-size: clamp(1.5rem, 2.5vw, 2rem);
    font-weight: 700;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple), var(--text-primary));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.75rem;
    letter-spacing: -0.02em;
    }

    .subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.5;
    }

    /* Panel Styling */
    .panel {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: fadeInUp 0.8s ease-out 0.2s backwards;
    display: flex;
    flex-direction: column;
    }

    .panel-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: rgba(13, 11, 21, 0.5);
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    }
    
    .music-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .credits-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: rgba(255, 46, 166, 0.1);
      border: 1px solid rgba(255, 46, 166, 0.3);
      border-radius: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }
    
    .version-dropdown {
      padding: 0.5rem 1rem;
      background: var(--dark-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .version-dropdown:hover {
      border-color: var(--aetherwave-purple);
    }

    .panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    }

    .panel-description {
    font-size: 0.85rem;
    color: var(--text-muted);
    }

    .panel-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    }

    /* Chat Interface */
    .chat-messages {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    }

    .message {
    animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
    }

    .message-label {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-muted);
    }

    .message-content {
    padding: 1rem 1.25rem;
    border-radius: 12px;
    line-height: 1.6;
    }

    .message.user .message-content {
    background: rgba(255, 46, 166, 0.1);
    border: 1px solid rgba(255, 46, 166, 0.3);
    margin-left: 2rem;
    }

    .message.assistant .message-content {
    background: rgba(139, 92, 246, 0.08);
    border: 1px solid var(--border-color);
    }

    .chat-input-area {
    padding: 1rem;
    border-top: 1px solid var(--border-color);
    background: rgba(13, 11, 21, 0.5);
    }

    /* Music Generation */
    .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    }
    
    /* Gender Toggle Buttons */
    .gender-toggle-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .gender-toggle-btn {
      flex: 1;
      padding: 0.75rem 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
    }
    
    .gender-toggle-btn:hover {
      border-color: var(--aetherwave-purple);
      background: rgba(139, 92, 246, 0.1);
    }
    
    .gender-toggle-btn.active {
      background: linear-gradient(135deg, var(--aetherwave-purple), var(--aetherwave-pink));
      border-color: var(--aetherwave-pink);
      color: white;
      font-weight: 600;
    }
    
    /* Premium Gradient Sliders */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      outline: none;
      margin: 0.5rem 0;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px rgba(255, 46, 166, 0.5);
      transition: all 0.2s;
    }
    
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px rgba(255, 46, 166, 0.8);
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 8px rgba(255, 46, 166, 0.5);
      transition: all 0.2s;
    }
    
    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px rgba(255, 46, 166, 0.8);
    }
    
    /* Slider value display */
    .slider-value-display {
      display: inline-block;
      min-width: 3rem;
      text-align: right;
      color: var(--aetherwave-purple);
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .slider-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    /* Premium Upload Audio Button */
    .premium-upload-btn {
      position: relative;
      padding: 0.75rem 2rem;
      background: linear-gradient(135deg, rgba(13, 11, 21, 0.95), rgba(20, 15, 35, 0.95));
      border: 2px solid transparent;
      border-radius: 24px;
      color: white;
      font-weight: 700;
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      cursor: pointer;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(24px);
      box-shadow: 
        0 4px 16px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    .premium-upload-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 24px;
      padding: 2px;
      background: linear-gradient(135deg, #00f5ff, #ff2ea6);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 1;
      transition: opacity 0.3s;
    }
    
    .premium-upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 8px 24px rgba(255, 46, 166, 0.3),
        0 0 20px rgba(0, 245, 255, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .premium-upload-btn:active {
      transform: translateY(0);
    }

    .form-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
    }

    textarea {
    padding: 0.75rem 1rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.9rem;
    font-family: inherit;
    outline: none;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s;
    }

    textarea:focus {
    border-color: var(--aetherwave-pink);
    }

    select {
    padding: 0.75rem 1rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.9rem;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
    }

    select:focus {
    border-color: var(--aetherwave-pink);
    }

    .btn-primary {
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    font-size: 0.95rem;
    }

    .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 46, 166, 0.4);
    }

    .btn-primary:active {
    transform: translateY(0);
    }

    .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    }

    .result-box {
    padding: 1rem;
    background: rgba(139, 92, 246, 0.08);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-top: 0.5rem;
    }

    .result-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    }

    audio {
    width: 100%;
    margin-bottom: 0.5rem;
    }

    .generated-image {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    }

    .download-btn {
    padding: 0.5rem 1rem;
    background: rgba(139, 92, 246, 0.2);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    }

    .download-btn:hover {
    background: rgba(139, 92, 246, 0.3);
    border-color: var(--aetherwave-purple);
    }

    .input-wrapper {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    }

    input[type="text"] {
    flex: 1;
    padding: 0.875rem 1.25rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 0.95rem;
    outline: none;
    transition: border-color 0.2s;
    }

    input[type="text"]:focus {
    border-color: var(--aetherwave-pink);
    }

    input[type="text"]::placeholder {
    color: var(--text-muted);
    }

    .send-btn {
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    }

    .send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 46, 166, 0.4);
    }

    .send-btn:active {
    transform: translateY(0);
    }

    /* Suggested Prompts */
    .suggestions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
    }

    .suggestion-chip {
    padding: 0.4rem 0.75rem;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    font-size: 0.75rem;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    }

    .suggestion-chip:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: var(--aetherwave-purple);
    color: var(--text-primary);
    }

    /* Use Case Cards */
    .use-case-card {
    position: relative;
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem 0.75rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: visible;
    }

    .use-case-card:hover {
    border-color: var(--aetherwave-purple);
    background: rgba(139, 92, 246, 0.1);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
    }

    .use-case-card.selected {
    border-color: var(--aetherwave-pink);
    background: rgba(255, 46, 166, 0.1);
    box-shadow: 0 4px 16px rgba(255, 46, 166, 0.3);
    }

    .use-case-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    filter: grayscale(0.3);
    transition: filter 0.3s ease;
    }

    .use-case-card:hover .use-case-icon {
    filter: grayscale(0);
    transform: scale(1.1);
    }

    .use-case-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
    }

    /* Tooltip Lightbox */
    .use-case-tooltip {
    position: absolute;
    bottom: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: rgba(26, 22, 37, 0.98);
    border: 1px solid var(--aetherwave-purple);
    border-radius: 12px;
    padding: 1rem;
    width: 280px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 100;
    backdrop-filter: blur(12px);
    }

    .use-case-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: var(--aetherwave-purple);
    }

    .use-case-card:hover .use-case-tooltip {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    pointer-events: auto;
    }

    .use-case-tooltip strong {
    display: block;
    color: var(--aetherwave-pink);
    font-size: 1rem;
    margin-bottom: 0.5rem;
    }

    .use-case-tooltip p {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 0.5rem;
    }

    .use-case-tooltip em {
    display: block;
    font-size: 0.75rem;
    color: var(--aetherwave-purple);
    font-style: italic;
    line-height: 1.4;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
    }

    /* Media Type Toggle Buttons */
    .media-type-btn:hover {
    transform: translateY(-2px);
    }

    .media-type-btn.active {
    background: var(--aetherwave-pink) !important;
    border-color: var(--aetherwave-pink) !important;
    color: white !important;
    box-shadow: 0 4px 16px rgba(255, 46, 166, 0.4);
    }

    @media (max-width: 1200px) {
    .panels-container {
    grid-template-columns: 1fr;
    grid-template-rows: auto;
    gap: 1rem;
    }
    
    .hero-text {
      grid-column: 1 / -1;
      grid-row: auto;
      padding: 1.5rem;
    }
    
    .panel-music,
    .panel-chat,
    .panel-media {
      grid-column: 1 / -1;
      grid-row: auto;
    }

    main {
    padding: 1rem;
    }
    }

    @media (max-width: 768px) {
    header {
    padding: 1rem;
    }

    nav {
    gap: 1rem;
    }

    nav a:not(.nav-btn) {
    display: none;
    }

    h1 {
    font-size: 1.5rem;
    }

    .subtitle {
    font-size: 0.9rem;
    }

    .message.user .message-content {
    margin-left: 0;
    }

    .panel-content {
    padding: 1rem;
    }
    }

    /* ===== PREMIUM AUDIO PLAYER (Option 2) ===== */
    
    .premium-track-card {
      background: linear-gradient(135deg, rgba(26, 22, 37, 0.9), rgba(13, 11, 21, 0.95));
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      backdrop-filter: blur(20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .premium-track-card:hover {
      transform: translateY(-2px);
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 12px 48px rgba(139, 92, 246, 0.2);
    }

    .track-content {
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
    }

    .track-artwork {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 12px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    .track-artwork img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .track-duration-badge {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .track-info {
      flex: 1;
      min-width: 0;
    }

    .track-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .track-artist {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .track-progress-container {
      margin-top: 0.75rem;
    }

    .track-progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(139, 92, 246, 0.2);
      border-radius: 2px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .track-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border-radius: 2px;
      width: 0%;
      transition: width 0.1s linear;
      position: relative;
    }

    .track-progress-fill::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .track-progress-bar:hover .track-progress-fill::after {
      opacity: 1;
    }

    .track-times {
      display: flex;
      justify-content: space-between;
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .track-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .control-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(255, 46, 166, 0.3);
    }

    .control-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 24px rgba(255, 46, 166, 0.5);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn-small {
      width: 36px;
      height: 36px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.3);
      box-shadow: none;
    }

    .control-btn-small:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.5);
    }

    .track-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(139, 92, 246, 0.1);
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .premium-track-card:hover .track-actions {
      opacity: 1;
      max-height: 100px;
    }

    .action-btn {
      flex: 1;
      padding: 0.625rem 1rem;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .action-btn:hover {
      background: rgba(139, 92, 246, 0.25);
      border-color: rgba(139, 92, 246, 0.5);
      transform: translateY(-1px);
    }

    /* Download Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 2rem;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .modal-subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .download-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .download-option {
      padding: 1rem;
      background: rgba(139, 92, 246, 0.08);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .download-option:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: var(--aetherwave-purple);
    }

    .download-option-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .download-option-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .download-option-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
    }

    .modal-btn {
      flex: 1;
      padding: 0.875rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
      color: white;
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255, 46, 166, 0.4);
    }

    .modal-btn-secondary {
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .modal-btn-secondary:hover {
      background: rgba(139, 92, 246, 0.25);
    }

  </style>
</head>
<body>
  <div class="bg-container">
    <div class="bg-grid"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
  </div>

  <header>
    <a href="/" class="logo">
    <div class="logo-icon2"><img class="logo-icon2" src='.\assets\Logo-SilverAlloy-Loop-1.gif'></div>
    <span><img width='300px' height='50px' src='.\assets\aws-logo.png'></span>
    </a>
    <nav>
    <a href="https://ai-hub.aetherwavestudio.com">AI Hub</a>
    <a href="/playlists/">Playlists</a>
    <a href="/featured-artist/">Featured Artist</a>
    <a href="/virtual-artists/">Virtual Artists</a>
    <a href="/shop/">Shop</a>
    <div id="auth-section" style="display: flex; align-items: center; gap: 1rem;">
      <a href="/api/login" class="nav-btn" id="login-btn" data-testid="button-login">Login</a>
      <div id="user-profile" style="display: none; align-items: center; gap: 0.75rem;">
        <img id="user-avatar" src="" alt="" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--aetherwave-purple);">
        <span id="user-name" style="color: var(--text-primary); font-size: 0.9rem;" data-testid="text-username"></span>
        <a href="/api/logout" class="nav-btn" style="padding: 0.5rem 1rem; font-size: 0.85rem;" data-testid="button-logout">Logout</a>
      </div>
    </div>
    </nav>
  </header>

  <main>
    <div class="panels-container">
    <!-- Music Generation Panel -->
    <div class="panel panel-music">
    <div class="panel-header">
    <div class="music-panel-header">
      <div class="credits-indicator" data-testid="credits-display">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
          <path d="M2 17l10 5 10-5"></path>
          <path d="M2 12l10 5 10-5"></path>
        </svg>
        <span id="user-credits">9.2k</span>
      </div>
      <select id="music-model-header" class="version-dropdown" data-testid="select-version">
        <option value="V5">v5 ▼</option>
        <option value="V4_5PLUS">v4.5+ ▼</option>
        <option value="V4_5">v4.5 ▼</option>
        <option value="V4">v4 ▼</option>
        <option value="V3_5">v3.5 ▼</option>
      </select>
    </div>
    <div style="margin-top: 0.5rem;">
      <div class="panel-title">🎵 Music Generation</div>
      <div class="panel-description">Create AI-generated music with SUNO</div>
    </div>
    </div>
    <div class="panel-content">
    <!-- Custom Mode Toggle -->
    <div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
    <input type="checkbox" id="custom-mode-toggle" style="width: auto; cursor: pointer;">
    <span class="form-label" style="margin: 0;">Custom Mode</span>
    </label>
    </div>

    <!-- Upload & Cover Audio File (Optional) -->
    <div class="form-group">
    <label class="form-label" id="upload-file-label">Audio File to Cover (Optional)</label>
    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
      <input type="file" id="upload-file" accept="audio/*,.mp3,.wav,.m4a,.ogg,.flac" style="display: none;" data-testid="input-upload-file">
      <button type="button" id="upload-file-btn" class="premium-upload-btn" data-testid="button-upload-file">UPLOAD AUDIO</button>
      <span id="upload-file-name" style="color: var(--text-muted); font-size: 0.85rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 120px;">No file selected</span>
      <button type="button" id="clear-upload-btn" style="display: none; padding: 0.5rem 0.75rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.85rem;" data-testid="button-clear-upload">Clear</button>
    </div>
    <input type="hidden" id="upload-url" data-testid="hidden-upload-url">
    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.25rem;">Upload an audio file to cover it with a new style while keeping the melody. Max 8 minutes, max 10MB.</p>
    </div>

    <!-- Simple Mode Fields -->
    <div id="simple-mode-fields">
    <div class="form-group">
    <label class="form-label" id="simple-prompt-label">Song Description <span id="simple-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/199)</span></label>
    <textarea id="music-prompt-simple" maxlength="199" placeholder="Describe the style of music and the topic you want, AI will generate lyrics for you"></textarea>
    </div>
    </div>

    <!-- Custom Mode Fields -->
    <div id="custom-mode-fields" style="display: none;">
    <div class="form-group">
    <label class="form-label" id="custom-title-label">Title</label>
    <input type="text" id="music-title" placeholder="Song title" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
    </div>
    <div class="form-group">
    <label class="form-label" id="custom-style-label">Style of Music</label>
    <input type="text" id="music-style" placeholder="e.g., ethereal, funk, dreamy, anthemic" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
    </div>
    <div class="form-group">
    <label class="form-label" id="custom-lyrics-label">Lyrics <span id="custom-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/3000)</span></label>
    <textarea id="music-lyrics" maxlength="3000" placeholder="Write your own lyrics, two verses (8 lines) for the best result" style="min-height: 120px;"></textarea>
    </div>
    </div>

<div id="advanced-options" style="display: none;">
  <details open>
    <summary style="cursor:pointer; font-weight:600; color:var(--aetherwave-purple); margin-bottom:1rem;">
      Advanced Options
    </summary>
    <div class="form-group">
      <label class="form-label">Vocal Gender 
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; opacity: 0.5;">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 16v-4"></path>
          <path d="M12 8h.01"></path>
        </svg>
      </label>
      <div class="gender-toggle-group">
        <button type="button" class="gender-toggle-btn active" data-gender="m" data-testid="button-gender-male">Male</button>
        <button type="button" class="gender-toggle-btn" data-gender="f" data-testid="button-gender-female">Female</button>
      </div>
      <input type="hidden" id="vocal-gender-value" value="m">
    </div>
    <div class="form-group">
      <div class="slider-label-row">
        <label for="style-weight" class="form-label">Style Weight</label>
        <span class="slider-value-display" id="style-weight-value">65%</span>
      </div>
      <input type="range" id="style-weight" min="0" max="1" step="0.01" value="0.65">
    </div>
    <div class="form-group">
      <div class="slider-label-row">
        <label for="weirdness-constraint" class="form-label">Weirdness</label>
        <span class="slider-value-display" id="weirdness-constraint-value">65%</span>
      </div>
      <input type="range" id="weirdness-constraint" min="0" max="1" step="0.01" value="0.65">
    </div>
    <div class="form-group">
      <div class="slider-label-row">
        <label for="audio-weight" class="form-label">Audio Weight</label>
        <span class="slider-value-display" id="audio-weight-value">65%</span>
      </div>
      <input type="range" id="audio-weight" min="0" max="1" step="0.01" value="0.65">
    </div>
  </details>
</div>

    <!-- Make Instrumental Toggle -->
    <div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
    <input type="checkbox" id="music-instrumental" style="width: auto; cursor: pointer;">
    <span class="form-label" style="margin: 0;">Make Instrumental</span>
    </label>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; margin-left: 1.5rem;">Create a song without lyrics</div>
    </div>

    <!-- Album Art Style Selector -->
    <!-- Wrap this dropdown in a container div -->
        <div id="album-art-style-container" style="display:none;">
        <label class="form-label">Album Art Style for auto-generated art</label>
        <select id="album-art-style">
    <option value="photorealistic" selected>Photorealistic</option>
    <option value="abstract">Abstract</option>
    <option value="cyberpunk">Cyberpunk</option>
    <option value="retro">Retro</option>
    <option value="minimal">Minimal</option>
    <option value="surreal">Surreal</option>
    <option value="cinematic">Cinematic</option>
    <option value="artistic">Artistic</option>
        </select>
        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
    Choose the visual style for Album Art
  </div>
</div>

    <button class="btn-primary" id="generate-music-btn">Generate Music</button>
    <div id="music-result" style="display: none;"></div>
    </div>
    </div>

    <!-- Hero Section -->
    <div class="hero-text">
    <h1>AI Music and Media Center</h1>
    <p class="subtitle">Create music, chat with AI, and generate album art - all in one creative studio</p>
    </div>

    <!-- Chat Panel -->
    <div class="panel panel-chat">
    <div class="panel-header">
    <div class="panel-title">💬 AetherWave AI</div>
    <div class="panel-description">Your creative companion</div>
    </div>
    <div class="panel-content">
    <div class="chat-messages">
    <div class="message assistant">
    <div class="message-label">AetherWave AI</div>
    <div class="message-content">
    Hello! I can help you create music, generate album art, or answer questions about AetherWave Studio. What would you like to create today?
    </div>
    </div>
    </div>
    </div>
    <div class="chat-input-area">
    <div class="input-wrapper">
    <input type="text" id="chat-input" placeholder="Ask me anything..." />
    <button class="send-btn" id="send-btn">Send</button>
    </div>
    <div class="suggestions">
    <div class="suggestion-chip">Prompts for Music</div>
    <div class="suggestion-chip">Lyric Generation</div>
    <div class="suggestion-chip">Album Art tips</div>
    </div>
    </div>
    </div>

    <!-- Visual Generation Panel -->
    <div class="panel panel-media">
    <div class="panel-header">
    <div class="panel-title">🎬 AI Media Generator</div>
    <div class="panel-description">Create images and videos for your music career</div>
    </div>
    <div class="panel-content">

    <!-- Step 1: Media Type Selection -->
    <div id="media-type-selection">
    <div class="form-group">
    <label class="form-label">What do you want to create?</label>
    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
    <button class="media-type-btn active" data-type="image" style="flex: 1; padding: 1rem; background: var(--accent-color); border: 2px solid var(--accent-color); border-radius: 12px; color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;">
    📸 Image
    </button>
    <button class="media-type-btn" data-type="video" style="flex: 1; padding: 1rem; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;">
    🎥 Video
    </button>
    </div>
    </div>
    </div>

    <!-- Step 2: Use Case Selection -->
    <div id="use-case-selection" style="margin-top: 1.5rem;">
    <div class="form-group">
    <label class="form-label">Choose your use case</label>
    <div class="use-case-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-top: 0.5rem;">

    <!-- Band Profile Card -->
    <div class="use-case-card" data-use-case="band-profile">
    <div class="use-case-icon">👤</div>
    <div class="use-case-name">Band Profile</div>
    <div class="use-case-tooltip">
    <strong>Band Profile</strong>
    <p>Professional artist photos for press kits, social media profiles, and promotional materials</p>
    <em>Example: "Indie rock band posing in urban alley with vintage instruments"</em>
    </div>
    </div>

    <!-- Live Photos Card -->
    <div class="use-case-card" data-use-case="live-photos">
    <div class="use-case-icon">🎸</div>
    <div class="use-case-name">Live Photos</div>
    <div class="use-case-tooltip">
    <strong>Live Photos</strong>
    <p>Dynamic concert and performance shots with energy and atmosphere</p>
    <em>Example: "Singer performing on stage with dramatic lighting and crowd"</em>
    </div>
    </div>

    <!-- Live Video Card -->
    <div class="use-case-card" data-use-case="live-video">
    <div class="use-case-icon">🎤</div>
    <div class="use-case-name">Live Video</div>
    <div class="use-case-tooltip">
    <strong>Live Video</strong>
    <p>Concert footage and performance clips for social media and promotion</p>
    <em>Example: "Guitarist shredding solo with flashing stage lights"</em>
    </div>
    </div>

    <!-- Production Video Card -->
    <div class="use-case-card" data-use-case="production-video">
    <div class="use-case-icon">🎬</div>
    <div class="use-case-name">Production Video</div>
    <div class="use-case-tooltip">
    <strong>Production Video</strong>
    <p>Professional music videos with cinematic quality and storytelling</p>
    <em>Example: "Cinematic shots of artist walking through neon-lit city"</em>
    </div>
    </div>

    <!-- Backstage Pass Card -->
    <div class="use-case-card" data-use-case="backstage">
    <div class="use-case-icon">🎭</div>
    <div class="use-case-name">Backstage Pass</div>
    <div class="use-case-tooltip">
    <strong>Backstage Pass</strong>
    <p>Behind-the-scenes content showing the artist life and creative process</p>
    <em>Example: "Band members relaxing in green room with instruments"</em>
    </div>
    </div>

    <!-- On The Road Card -->
    <div class="use-case-card" data-use-case="on-the-road">
    <div class="use-case-icon">🚐</div>
    <div class="use-case-name">On The Road</div>
    <div class="use-case-tooltip">
    <strong>On The Road</strong>
    <p>Tour life, travel scenes, and adventure content for storytelling</p>
    <em>Example: "Tour bus driving through desert landscape at sunset"</em>
    </div>
    </div>

    <!-- Album Art Card -->
    <div class="use-case-card" data-use-case="album-art">
    <div class="use-case-icon">💿</div>
    <div class="use-case-name">Album Art</div>
    <div class="use-case-tooltip">
    <strong>Album Art</strong>
    <p>Square format cover art for singles, EPs, and full albums</p>
    <em>Example: "Abstract geometric shapes in vibrant neon colors"</em>
    </div>
    </div>

    <!-- News Reports Card -->
    <div class="use-case-card" data-use-case="news-reports">
    <div class="use-case-icon">📰</div>
    <div class="use-case-name">News Reports</div>
    <div class="use-case-tooltip">
    <strong>News Reports</strong>
    <p>Press-style imagery and announcement visuals for releases and events</p>
    <em>Example: "Breaking news style graphic with artist announcement"</em>
    </div>
    </div>

    </div>
    </div>
    </div>

    <!-- Step 3: Generation Settings (shown after use case selected) -->
    <div id="generation-settings" style="display: none; margin-top: 1.5rem;">

    <!-- Enhanced Prompt Preview -->
    <div class="form-group">
    <label class="form-label">AI Prompt (edit to customize)</label>
    <textarea id="enhanced-prompt" rows="4" placeholder="Your enhanced prompt will appear here..." style="font-family: monospace; font-size: 0.9rem;"></textarea>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">This is the full prompt sent to the AI. Feel free to edit it!</div>
    </div>

    <!-- User's Creative Input -->
    <div class="form-group">
    <label class="form-label">Your Vision (optional - add custom details)</label>
    <textarea id="user-vision" rows="2" placeholder="e.g., wearing leather jacket, vintage 80s aesthetic, purple color scheme..."></textarea>
    </div>

    <!-- Image Upload (Optional) -->
<div class="form-group" id="image-upload-group">
  <label class="form-label">
    <span>Upload Image (Optional)</span>
    <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: normal; margin-left: 0.5rem;">- Upload reference image here</span>
  </label>
  <input type="file" id="media-image-upload" accept="image/*" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer;">
</div>

<!-- Start Image (First Frame) Uploader -->
<div class="form-group" id="start-image-group" style="display:none;">
  <label class="form-label">Start Frame (Image or URL)</label>
  <input type="file" id="start-image-file" accept="image/*" style="margin-bottom:0.5rem;">
  <input type="text" id="start-image-url" placeholder="or paste image URL" style="width:100%;">
</div>

<!-- End Image (Last Frame) Uploader -->
<div class="form-group" id="end-image-group" style="display:none;">
  <label class="form-label">End Frame (Image or URL)</label>
  <input type="file" id="end-image-file" accept="image/*" style="margin-bottom:0.5rem;">
  <input type="text" id="end-image-url" placeholder="or paste image URL" style="width:100%;">
</div>



    <!-- Image Mode Selection (shown only for video when image uploaded) -->
    <div id="image-mode-selection" style="display: none; margin-top: 0.75rem;">
    <label class="form-label">How should the image be used?</label>
    <select id="image-mode" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
    <option value="first-frame">First Frame - Start video with this image</option>
    <option value="reference">Style Reference - Use as visual inspiration (1-4 images)</option>
    </select>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
    <strong>First Frame:</strong> Image becomes the opening frame, AI animates from there<br>
    <strong>Reference:</strong> AI uses image(s) as style guide but creates new content
    </div>
    

    <div id="media-image-preview" style="display: none; margin-top: 0.5rem;">
    <img id="media-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);" />
    <button type="button" id="media-clear-image" class="download-btn" style="margin-top: 0.5rem; display: inline-block;">Clear Image</button>
    </div>
    </div>

    <!-- Image Style Selector (only for images, not videos) -->
    <div class="form-group" id="image-style-group" style="display: block;">
    <label class="form-label">Image Style</label>
    <select id="media-image-style">
    <option value="photorealistic">Photorealistic</option>
    <option value="abstract">Abstract</option>
    <option value="cyberpunk">Cyberpunk</option>
    <option value="retro">Retro</option>
    <option value="minimal">Minimal</option>
    <option value="surreal">Surreal</option>
    <option value="cinematic">Cinematic</option>
    <option value="artistic">Artistic</option>
    </select>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">Choose the visual style for your generated image</div>
    </div>

    <!-- Advanced Settings (collapsible) -->
    <div class="form-group">
    <details>
    <summary style="cursor: pointer; font-weight: 600; color: var(--accent-color); margin-bottom: 1rem;">⚙️ Advanced Settings</summary>

    <div class="form-group" id="video-settings-group" style="display: none;">
    <label class="form-label">Quality</label>
    <select id="media-quality">
    <option value="lite" selected>Fast (Lite Model)</option>
    <option value="pro">High Quality (Pro Model)</option>
    </select>
    </div>

    <div class="form-group" id="video-resolution-group" style="display: none;">
    <label class="form-label">Resolution</label>
    <select id="media-resolution">
    <option value="512p">512p (Fastest, Lower Quality)</option>
    <option value="720p" selected>720p (Balanced)</option>
    <option value="1080p">1080p (Highest Quality, Slower)</option>
    </select>
    </div>

    <div class="form-group" id="video-duration-group" style="display: none;">
    <label class="form-label">Duration</label>
    <select id="media-duration">
    <option value="5" selected>5 seconds</option>
    <option value="10">10 seconds</option>
    </select>
    </div>

    <div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
    <input type="checkbox" id="media-safety-checker" checked style="width: auto; cursor: pointer;">
    <span class="form-label" style="margin: 0;">Enable Safety Checker</span>
    </label>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; margin-left: 1.5rem;">Uncheck if getting false rejections</div>
    </div>
    </details>
    </div>

    <!-- Generate Button -->
    <button class="btn-primary" id="generate-media-btn" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600;">
    🎨 Generate <span id="media-type-label">Image</span>
    </button>

    <!-- Back Button -->
    <button class="download-btn" id="back-to-use-cases" style="width: 100%; margin-top: 0.5rem;">
    ← Back to Use Cases
    </button>
    </div>

    <!-- Results Display -->
    <div id="media-result" style="display: none; margin-top: 1.5rem;"></div>
    </div>
    </div>
    </div>
  </main>

  <script>
    // Error handling wrapper
    window.addEventListener('error', (e) => {
    console.error('Global error:', e.message, e.filename, e.lineno, e.colno);
    });

    // Check authentication status and update UI
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/user');
        if (response.ok) {
          const user = await response.json();
          // User is logged in
          document.getElementById('login-btn').style.display = 'none';
          document.getElementById('user-profile').style.display = 'flex';
          document.getElementById('user-name').textContent = user.firstName || user.email || 'User';
          if (user.profileImageUrl) {
            document.getElementById('user-avatar').src = user.profileImageUrl;
            document.getElementById('user-avatar').alt = user.firstName || 'User';
          } else {
            // Use a default avatar if no profile image
            document.getElementById('user-avatar').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238b5cf6"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
            document.getElementById('user-avatar').alt = user.email || 'User';
          }
          
          // Load user's vocal gender preference
          if (user.vocalGenderPreference) {
            const genderBtn = document.querySelector(`.gender-toggle-btn[data-gender="${user.vocalGenderPreference}"]`);
            if (genderBtn) {
              document.querySelectorAll('.gender-toggle-btn').forEach(b => b.classList.remove('active'));
              genderBtn.classList.add('active');
              document.getElementById('vocal-gender-value').value = user.vocalGenderPreference;
            }
          }
        } else {
          // User not logged in
          document.getElementById('login-btn').style.display = 'inline-block';
          document.getElementById('user-profile').style.display = 'none';
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        // Show login button on error
        document.getElementById('login-btn').style.display = 'inline-block';
        document.getElementById('user-profile').style.display = 'none';
      }
    }

    // Check auth on page load
    checkAuth();

    // Credit Management
    let userCredits = 50;
    let userPlanType = 'free';
    
    async function fetchUserCredits() {
      try {
        const response = await fetch('/api/user/credits');
        if (response.ok) {
          const data = await response.json();
          userCredits = data.credits;
          userPlanType = data.planType;
          updateCreditsDisplay();
          
          // Auto-check for daily reset
          await checkDailyReset();
        } else if (response.status === 401) {
          // User not authenticated - hide credits display
          const creditsIndicator = document.querySelector('.credits-indicator');
          if (creditsIndicator) {
            creditsIndicator.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Failed to fetch credits:', error);
        // Hide credits on error
        const creditsIndicator = document.querySelector('.credits-indicator');
        if (creditsIndicator) {
          creditsIndicator.style.display = 'none';
        }
      }
    }
    
    async function checkDailyReset() {
      try {
        const response = await fetch('/api/user/credits/check-reset', { method: 'POST' });
        if (response.ok) {
          const data = await response.json();
          if (data.resetOccurred) {
            userCredits = data.credits;
            updateCreditsDisplay();
            showNotification('Daily credits reset! You now have 50 credits.', 'success');
          }
        }
      } catch (error) {
        console.error('Failed to check daily reset:', error);
      }
    }
    
    function updateCreditsDisplay() {
      const creditsElement = document.getElementById('credits-count');
      const creditsIndicator = document.querySelector('.credits-indicator');
      
      if (creditsElement && creditsIndicator) {
        // Show the indicator
        creditsIndicator.style.display = 'flex';
        
        if (userPlanType === 'studio' || userPlanType === 'all_access') {
          creditsElement.textContent = '∞';
          creditsIndicator.title = 'Unlimited credits - Click to view plans';
        } else {
          creditsElement.textContent = userCredits;
          creditsIndicator.title = `${userCredits} credits remaining - Click to upgrade`;
        }
      }
    }
    
    async function deductCredits(amount = 5) {
      try {
        const response = await fetch('/api/user/credits/deduct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount })
        });
        
        if (!response.ok) {
          const data = await response.json();
          if (response.status === 403) {
            // Insufficient credits - show payment modal
            showPaymentModal();
            throw new Error('Insufficient credits');
          }
          throw new Error(data.message || 'Failed to deduct credits');
        }
        
        const data = await response.json();
        userCredits = data.credits;
        updateCreditsDisplay();
        return true;
      } catch (error) {
        console.error('Failed to deduct credits:', error);
        throw error;
      }
    }
    
    function showPaymentModal() {
      const modal = document.createElement('div');
      modal.id = 'payment-modal';
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(13, 11, 21, 0.95);
        backdrop-filter: blur(12px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        animation: fadeIn 0.3s ease-out;
      `;
      
      modal.innerHTML = `
        <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 24px; max-width: 900px; width: 100%; box-shadow: 0 24px 80px rgba(0, 0, 0, 0.8); animation: slideUp 0.4s ease-out;">
          <div style="padding: 2rem; border-bottom: 1px solid var(--border-color);">
            <h2 style="font-size: 1.75rem; font-weight: 700; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
              Upgrade Your Plan
            </h2>
            <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.95rem;">
              You've run out of credits! Choose a plan to continue creating amazing content.
            </p>
          </div>
          
          <div style="padding: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem;">
            
            <!-- Free Plan -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.75rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">🎵</div>
                <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Free</h3>
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">$0<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-muted);">/month</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.5rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>50 credits/day</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Basic music generation</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Standard quality</span>
                </li>
              </ul>
              <div style="text-align: center; color: var(--text-muted); font-size: 0.85rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                Current Plan
              </div>
            </div>
            
            <!-- Studio Member -->
            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(255, 46, 166, 0.05)); border: 2px solid var(--aetherwave-purple); border-radius: 16px; padding: 1.75rem; display: flex; flex-direction: column; position: relative; overflow: hidden;">
              <div style="position: absolute; top: 0.75rem; right: 0.75rem; background: var(--aetherwave-purple); color: white; font-size: 0.7rem; font-weight: 600; padding: 0.35rem 0.75rem; border-radius: 12px;">POPULAR</div>
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">🎸</div>
                <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">Studio Member</h3>
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">$20<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-muted);">/month</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.5rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> music credits</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>High-quality audio</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Priority generation</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-purple);">✓</span>
                  <span>Commercial license</span>
                </li>
              </ul>
              <button onclick="contactSupport('Studio Member')" style="width: 100%; padding: 0.875rem; background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple)); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.95rem; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(255, 46, 166, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                Contact for Upgrade
              </button>
            </div>
            
            <!-- All Access Pass -->
            <div style="background: rgba(255, 255, 255, 0.02); border: 2px solid var(--border-color); border-radius: 16px; padding: 1.75rem; display: flex; flex-direction: column;">
              <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">🎬</div>
                <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.5rem 0;">All Access Pass</h3>
                <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">$50<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-muted);">/month</span></div>
              </div>
              <ul style="list-style: none; padding: 0; margin: 0 0 1.5rem 0; flex: 1;">
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">Everything</strong> in Studio</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span><strong style="color: var(--text-primary);">Unlimited</strong> video/image</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>4K video generation</span>
                </li>
                <li style="color: var(--text-muted); font-size: 0.9rem; padding: 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                  <span style="color: var(--aetherwave-pink);">✓</span>
                  <span>API access</span>
                </li>
              </ul>
              <button onclick="contactSupport('All Access Pass')" style="width: 100%; padding: 0.875rem; background: rgba(139, 92, 246, 0.2); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.95rem; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'; this.style.borderColor='var(--aetherwave-purple)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'; this.style.borderColor='var(--border-color)'">
                Contact for Upgrade
              </button>
            </div>
          </div>
          
          <div style="padding: 1.5rem 2rem; border-top: 1px solid var(--border-color); display: flex; justify-content: center;">
            <button onclick="closePaymentModal()" style="padding: 0.75rem 2rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); border-radius: 12px; font-weight: 500; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--aetherwave-purple)'; this.style.color='var(--text-primary)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.color='var(--text-muted)'">
              Maybe Later
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    function closePaymentModal() {
      const modal = document.getElementById('payment-modal');
      if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => modal.remove(), 300);
      }
    }
    
    function contactSupport(planName) {
      alert(`To upgrade to ${planName}, please contact Replit support or the application developer. Payment integration coming soon!`);
      closePaymentModal();
    }
    
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: ${type === 'success' ? 'rgba(74, 222, 128, 0.15)' : 'rgba(139, 92, 246, 0.15)'};
        border: 1px solid ${type === 'success' ? 'rgba(74, 222, 128, 0.3)' : 'rgba(139, 92, 246, 0.3)'};
        color: var(--text-primary);
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(12px);
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
        max-width: 400px;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Add click handler to credits indicator to show payment modal
    setTimeout(() => {
      const creditsIndicator = document.querySelector('.credits-indicator');
      if (creditsIndicator) {
        creditsIndicator.style.cursor = 'pointer';
        creditsIndicator.title = 'Click to upgrade';
        creditsIndicator.addEventListener('click', showPaymentModal);
      }
    }, 1000);
    
    // Fetch credits on page load
    setTimeout(() => {
      fetchUserCredits();
    }, 500);

        const mediaTypeBtns = document.querySelectorAll('.media-type-btn');
        let selectedMediaType = document.querySelector('.media-type-btn.active').dataset.type;

// ...rest of your code, using mediaTypeBtns...


    // Chat functionality
    const chatMessages = document.querySelector('.chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const suggestionChips = document.querySelectorAll('.suggestion-chip');

    // Music generation - Elements
    const customModeToggle = document.getElementById('custom-mode-toggle');
    const simpleModeFields = document.getElementById('simple-mode-fields');
    const customModeFields = document.getElementById('custom-mode-fields');
    const musicPromptSimple = document.getElementById('music-prompt-simple');
    const musicTitle = document.getElementById('music-title');
    const musicStyle = document.getElementById('music-style');
    const musicLyrics = document.getElementById('music-lyrics');
    const musicModelHeader = document.getElementById('music-model-header');
    const musicInstrumental = document.getElementById('music-instrumental');
    const generateMusicBtn = document.getElementById('generate-music-btn');
    const musicResult = document.getElementById('music-result');
    const simpleCharCount = document.getElementById('simple-char-count');
    const customCharCount = document.getElementById('custom-char-count');



        // Place this near other helper functions or at top, after DOM ready
        async function handleImageInput(fileInput, urlInput) {
        const file = fileInput.files[0];
        if (file) {
    return new Promise((resolve, reject) => {
     const reader = new FileReader();
     reader.onload = e => resolve(e.target.result);
     reader.onerror = e => reject(e);
     reader.readAsDataURL(file);
    });
  }
  // If no file, but URL provided
  if (urlInput.value && urlInput.value.trim() !== '') {
    return urlInput.value.trim();
  }
  return null;
}

    // Custom Mode Toggle
    customModeToggle.addEventListener('change', () => {
    if (customModeToggle.checked) {
    simpleModeFields.style.display = 'none';
    customModeFields.style.display = 'block';
    } else {
    simpleModeFields.style.display = 'block';
    customModeFields.style.display = 'none';
    }
    });
        
const advancedOptions = document.getElementById('advanced-options');

// Show/hide Advanced Options based on custom mode
customModeToggle.addEventListener('change', function() {
  if (customModeToggle.checked) {
    advancedOptions.style.display = 'block';
  } else {
    advancedOptions.style.display = 'none';
  }
});



// Also set initial visibility at page load:
if (customModeToggle.checked) {
  advancedOptions.style.display = 'block';
} else {
  advancedOptions.style.display = 'none';
}

// Gender Toggle Button Logic
const genderToggleBtns = document.querySelectorAll('.gender-toggle-btn');
const vocalGenderValue = document.getElementById('vocal-gender-value');

genderToggleBtns.forEach(btn => {
  btn.addEventListener('click', function() {
    // Remove active from all buttons
    genderToggleBtns.forEach(b => b.classList.remove('active'));
    // Add active to clicked button
    this.classList.add('active');
    // Update hidden input value
    vocalGenderValue.value = this.dataset.gender;
  });
});

// Slider live value update logic (with percentage display)
['style-weight', 'weirdness-constraint', 'audio-weight'].forEach(function(id) {
  const slider = document.getElementById(id);
  const output = document.getElementById(id + '-value');
  if (slider && output) {
    slider.addEventListener('input', function() {
      const percentage = Math.round(slider.value * 100);
      output.textContent = percentage + '%';
    });
  }
});

// Function to update required field indicators (red asterisks)
function updateRequiredFields() {
  const uploadUrl = document.getElementById('upload-url').value.trim();
  const isCustomMode = customModeToggle.checked;
  const isInstrumental = musicInstrumental.checked;
  
  // Get label elements
  const simpleLabelEl = document.getElementById('simple-prompt-label');
  const titleLabelEl = document.getElementById('custom-title-label');
  const styleLabelEl = document.getElementById('custom-style-label');
  const lyricsLabelEl = document.getElementById('custom-lyrics-label');
  
  // Reset all labels to base text
  simpleLabelEl.innerHTML = 'Song Description <span id="simple-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/199)</span>';
  titleLabelEl.textContent = 'Title';
  styleLabelEl.textContent = 'Style of Music';
  lyricsLabelEl.innerHTML = 'Lyrics <span id="custom-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/3000)</span>';
  
  // Apply red asterisk to required fields
  const asterisk = '<span style="color: #ff2ea6; margin-left: 0.25rem;">*</span>';
  
  if (!isCustomMode) {
    // Non-custom mode: prompt is always required
    simpleLabelEl.innerHTML = 'Song Description' + asterisk + ' <span id="simple-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/199)</span>';
  } else {
    // Custom mode
    // Title and Style are always required in custom mode
    titleLabelEl.innerHTML = 'Title' + asterisk;
    styleLabelEl.innerHTML = 'Style of Music' + asterisk;
    
    // Lyrics only required if NOT instrumental
    if (!isInstrumental) {
      lyricsLabelEl.innerHTML = 'Lyrics' + asterisk + ' <span id="custom-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/3000)</span>';
    }
  }
  
  // Update character counters after HTML changes
  const simpleCount = musicPromptSimple.value.length;
  const customCount = musicLyrics.value.length;
  const simpleCharCountEl = document.getElementById('simple-char-count');
  const customCharCountEl = document.getElementById('custom-char-count');
  if (simpleCharCountEl) simpleCharCountEl.textContent = `(${simpleCount}/199)`;
  if (customCharCountEl) customCharCountEl.textContent = `(${customCount}/3000)`;
}

// Update required fields on mode/instrumental changes
customModeToggle.addEventListener('change', updateRequiredFields);
musicInstrumental.addEventListener('change', updateRequiredFields);

// Update on file upload/clear
const uploadUrlHidden = document.getElementById('upload-url');
const observer = new MutationObserver(updateRequiredFields);
observer.observe(uploadUrlHidden, { attributes: true, attributeFilter: ['value'] });

// Initial update
updateRequiredFields();

// ===== PREMIUM PLAYER CONTROLLER =====
window.premiumPlayer = {
  currentTrack: null,
  audioElements: new Map(),
  downloadData: {},
  selectedFormat: 'mp3',

  init() {
    // Get all audio elements and set up event listeners
    const audioElements = document.querySelectorAll('audio[data-track-id]');
    
    audioElements.forEach(audio => {
      const trackId = audio.getAttribute('data-track-id');
      this.audioElements.set(trackId, audio);
      
      // Set up event listeners for this audio element
      audio.addEventListener('loadedmetadata', () => this.onMetadataLoaded(trackId));
      audio.addEventListener('timeupdate', () => this.onTimeUpdate(trackId));
      audio.addEventListener('ended', () => this.onTrackEnded(trackId));
    });
  },

  onMetadataLoaded(trackId) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    const card = document.querySelector(`[data-track-id="${trackId}"]`);
    if (!card) return;
    
    const duration = audio.duration;
    const durationBadge = card.querySelector('.track-duration-badge');
    const totalTime = card.querySelector('.total-time');
    
    const formattedDuration = this.formatTime(duration);
    if (durationBadge) durationBadge.textContent = formattedDuration;
    if (totalTime) totalTime.textContent = formattedDuration;
  },

  onTimeUpdate(trackId) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    const card = document.querySelector(`[data-track-id="${trackId}"]`);
    if (!card) return;
    
    const progress = (audio.currentTime / audio.duration) * 100;
    const progressFill = card.querySelector('.track-progress-fill');
    const currentTimeEl = card.querySelector('.current-time');
    
    if (progressFill) progressFill.style.width = `${progress}%`;
    if (currentTimeEl) currentTimeEl.textContent = this.formatTime(audio.currentTime);
  },

  onTrackEnded(trackId) {
    const card = document.querySelector(`[data-track-id="${trackId}"]`);
    if (!card) return;
    
    const playIcon = card.querySelector('.play-icon');
    const pauseIcon = card.querySelector('.pause-icon');
    
    if (playIcon) playIcon.style.display = 'block';
    if (pauseIcon) pauseIcon.style.display = 'none';
  },

  togglePlay(trackId) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    const card = document.querySelector(`[data-track-id="${trackId}"]`);
    if (!card) return;
    
    const playIcon = card.querySelector('.play-icon');
    const pauseIcon = card.querySelector('.pause-icon');
    
    // Pause all other tracks
    this.audioElements.forEach((otherAudio, otherId) => {
      if (otherId !== trackId && !otherAudio.paused) {
        otherAudio.pause();
        const otherCard = document.querySelector(`[data-track-id="${otherId}"]`);
        if (otherCard) {
          const otherPlayIcon = otherCard.querySelector('.play-icon');
          const otherPauseIcon = otherCard.querySelector('.pause-icon');
          if (otherPlayIcon) otherPlayIcon.style.display = 'block';
          if (otherPauseIcon) otherPauseIcon.style.display = 'none';
        }
      }
    });
    
    if (audio.paused) {
      audio.play();
      if (playIcon) playIcon.style.display = 'none';
      if (pauseIcon) pauseIcon.style.display = 'block';
      this.currentTrack = trackId;
    } else {
      audio.pause();
      if (playIcon) playIcon.style.display = 'block';
      if (pauseIcon) pauseIcon.style.display = 'none';
    }
  },

  seek(trackId, event) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const percentage = x / rect.width;
    
    audio.currentTime = percentage * audio.duration;
  },

  previous(trackId) {
    const audio = this.audioElements.get(trackId);
    if (!audio) return;
    
    // If more than 3 seconds in, restart current track
    if (audio.currentTime > 3) {
      audio.currentTime = 0;
    } else {
      // Go to previous track
      const trackIds = Array.from(this.audioElements.keys());
      const currentIndex = trackIds.indexOf(trackId);
      if (currentIndex > 0) {
        this.togglePlay(trackIds[currentIndex - 1]);
      }
    }
  },

  next(trackId) {
    const trackIds = Array.from(this.audioElements.keys());
    const currentIndex = trackIds.indexOf(trackId);
    if (currentIndex < trackIds.length - 1) {
      this.togglePlay(trackIds[currentIndex + 1]);
    }
  },

  formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  },

  openDownloadModal(trackId, title, url) {
    this.downloadData = { trackId, title, url };
    this.selectedFormat = 'mp3';
    
    const modal = document.getElementById('download-modal');
    const modalTitle = document.getElementById('modal-track-title');
    
    if (modalTitle) modalTitle.textContent = title;
    if (modal) modal.style.display = 'flex';
    
    // Reset selection UI
    document.querySelectorAll('.download-option').forEach(opt => {
      opt.style.background = 'rgba(139, 92, 246, 0.08)';
      opt.style.borderColor = 'var(--border-color)';
    });
    
    // Highlight MP3 by default
    const mp3Option = document.querySelector('[data-testid="option-mp3"]');
    if (mp3Option) {
      mp3Option.style.background = 'rgba(139, 92, 246, 0.15)';
      mp3Option.style.borderColor = 'var(--aetherwave-purple)';
    }
  },

  closeDownloadModal() {
    const modal = document.getElementById('download-modal');
    if (modal) modal.style.display = 'none';
  },

  selectFormat(format) {
    this.selectedFormat = format;
    
    // Update UI to show selection
    document.querySelectorAll('.download-option').forEach(opt => {
      opt.style.background = 'rgba(139, 92, 246, 0.08)';
      opt.style.borderColor = 'var(--border-color)';
    });
    
    const selectedOption = document.querySelector(`[data-testid="option-${format}"]`);
    if (selectedOption) {
      selectedOption.style.background = 'rgba(139, 92, 246, 0.15)';
      selectedOption.style.borderColor = 'var(--aetherwave-purple)';
    }
  },

  confirmDownload() {
    const { title, url } = this.downloadData;
    const filename = `${title}.${this.selectedFormat}`;
    
    // Create a temporary download link
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    this.closeDownloadModal();
  }
};


    // Character counter for Simple Mode
    musicPromptSimple.addEventListener('input', () => {
    const charCount = musicPromptSimple.value.length;
    simpleCharCount.textContent = `(${charCount}/199)`;
    });

    // Character counter for Custom Mode Lyrics
    musicLyrics.addEventListener('input', () => {
    const charCount = musicLyrics.value.length;
    customCharCount.textContent = `(${charCount}/3000)`;
    });

    // NEW Visual Generation System - Use Case Based
    //const mediaTypeBtns = document.querySelectorAll('.media-type-btn');
    const useCaseCards = document.querySelectorAll('.use-case-card');
    const generationSettings = document.getElementById('generation-settings');
    const enhancedPrompt = document.getElementById('enhanced-prompt');
    const userVision = document.getElementById('user-vision');
    const mediaImageUpload = document.getElementById('media-image-upload');
    const mediaImagePreview = document.getElementById('media-image-preview');
    const mediaPreviewImg = document.getElementById('media-preview-img');
    const mediaClearImage = document.getElementById('media-clear-image');
    const imageModeSelection = document.getElementById('image-mode-selection');
    const imageMode = document.getElementById('image-mode');
    const mediaQuality = document.getElementById('media-quality');
    const mediaResolution = document.getElementById('media-resolution');
    const mediaDuration = document.getElementById('media-duration');
    const mediaSafetyChecker = document.getElementById('media-safety-checker');
    const generateMediaBtn = document.getElementById('generate-media-btn');
    const generateArtBtn = document.getElementById('generate-art-btn');
    const mediaTypeLabel = document.getElementById('media-type-label');
    const backToUseCases = document.getElementById('back-to-use-cases');
    const mediaResult = document.getElementById('media-result');
    const videoSettingsGroup = document.getElementById('video-settings-group');
    const videoResolutionGroup = document.getElementById('video-resolution-group');
    const videoDurationGroup = document.getElementById('video-duration-group');
    const imageStyleGroup = document.getElementById('image-style-group');
    const mediaImageStyle = document.getElementById('media-image-style');

    // State management'
    let selectedUseCase = null;
    let uploadedImageData = null;





    // Prompt templates for each use case
    const promptTemplates = {
    'band-profile': {
    image: 'Professional artist portrait photography: {vision}. Studio lighting, high quality, detailed, press kit worthy, promotional photo style.',
    video: 'Cinematic portrait footage: {vision}. Professional lighting, slow camera movement, artist posing confidently, high production value.'
    },
    'live-photos': {
    image: 'Live concert photography: {vision}. Dynamic stage lighting, energetic performance, crowd atmosphere, professional music photography.',
    video: 'Live performance footage: {vision}. Concert stage with dramatic lighting, energetic movement, crowd energy, professional concert videography.'
    },
    'live-video': {
    image: 'Concert performance shot: {vision}. Stage lights, live music energy, performance intensity, concert photography.',
    video: 'Live concert performance: {vision}. Dynamic camera angles, stage lighting effects, musician performing live, concert film quality.'
    },
    'production-video': {
    image: 'Cinematic music video still: {vision}. Professional cinematography, artistic composition, music video aesthetic, high production value.',
    video: 'Professional music video production: {vision}. Cinematic camera work, artistic storytelling, high-quality cinematography, music video style.'
    },
    'backstage': {
    image: 'Behind-the-scenes music photography: {vision}. Candid backstage moments, authentic artist life, documentary photography style.',
    video: 'Backstage documentary footage: {vision}. Behind-the-scenes access, authentic moments, candid artist interactions, documentary style.'
    },
    'on-the-road': {
    image: 'Tour life photography: {vision}. Travel documentary style, authentic road moments, touring musician lifestyle, candid shots.',
    video: 'Tour documentary footage: {vision}. Travel scenes, road life, touring musician journey, documentary cinematography.'
    },
    'album-art': {
    image: 'Album cover art design: {vision}. Square format, artistic composition, professional album artwork, high-quality graphic design.',
    video: 'Animated album artwork: {vision}. Square format, artistic motion graphics, professional album art animation, looping visual.'
    },
    'news-reports': {
    image: 'Music news press image: {vision}. Professional news photography, press release quality, announcement graphic style.',
    video: 'Music news announcement video: {vision}. News report style, professional presentation, press announcement format.'
    }
    };

    
        // When Generate Album Art button is clicked, show the dropdown.
        document.addEventListener('click', function(e) {
        if (e.target && e.target.matches('.download-btn[onclick*="Generate Album Art"]')) {
    document.getElementById('album-art-style-container').style.display = 'block';
    document.getElementById('album-art-style').value = 'photorealistic';
                }
        });

        // Media type toggle
    mediaTypeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
    mediaTypeBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedMediaType = btn.dataset.type;
    mediaTypeLabel.textContent = selectedMediaType === 'image' ? 'Image' : 'Video';
        
        

    // Show/hide video-specific settings and image-specific settings
    if (selectedMediaType === 'video') {
    videoSettingsGroup.style.display = 'block';
    videoResolutionGroup.style.display = 'block';
    videoDurationGroup.style.display = 'block';
    imageStyleGroup.style.display = 'none'; // Hide image style for video
    } else {
    videoSettingsGroup.style.display = 'none';
    videoResolutionGroup.style.display = 'none';
    videoDurationGroup.style.display = 'none';
    imageStyleGroup.style.display = 'block'; // Show image style for image
    }
        // Call updateMediaInputs whenever media type is toggled
        mediaTypeBtns.forEach(btn => {
        btn.addEventListener('click', updateMediaInputs);
        });
    // Update enhanced prompt if use case already selected
    if (selectedUseCase) {
    updateEnhancedPrompt();
    }
    });
    });

    // Use case selection
    useCaseCards.forEach(card => {
    card.addEventListener('click', () => {
    useCaseCards.forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedUseCase = card.dataset.useCase;



    // Show generation settings
    generationSettings.style.display = 'block';

    // Update enhanced prompt
    updateEnhancedPrompt();

    // Scroll to settings
    setTimeout(() => {
    generationSettings.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    });
    });

    // Update enhanced prompt based on use case and user vision
    function updateEnhancedPrompt() {
    if (!selectedUseCase) return;

    const template = promptTemplates[selectedUseCase][selectedMediaType];
    const vision = userVision.value.trim() || 'artist/band';
    const finalPrompt = template.replace('{vision}', vision);

    enhancedPrompt.value = finalPrompt;
    }

    // User vision input updates prompt
    userVision.addEventListener('input', updateEnhancedPrompt);

    // Back button
    backToUseCases.addEventListener('click', () => {
    generationSettings.style.display = 'none';
    useCaseCards.forEach(c => c.classList.remove('selected'));
    selectedUseCase = null;
    enhancedPrompt.value = '';
    userVision.value = '';
    mediaResult.style.display = 'none';
    });

    // Handle image upload for media generator
    mediaImageUpload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Check file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
    if (!validTypes.includes(file.type)) {
    alert('Invalid image format. Please use JPG, PNG, WEBP, or GIF.');
    mediaImageUpload.value = '';
    return;
    }

    // Check file size (max 5MB for better compatibility)
    if (file.size > 5 * 1024 * 1024) {
    alert('Image file is too large. Please use an image under 5MB.');
    mediaImageUpload.value = '';
    return;
    }

    // Read file as base64 and validate dimensions
    const reader = new FileReader();
    reader.onload = (event) => {
    const img = new Image();
    img.onload = () => {
    // Check dimensions (recommend 720p or less for best results)
    const maxDimension = 1920;
    if (img.width > maxDimension || img.height > maxDimension) {
    if (!confirm(`Image is ${img.width}x${img.height}. Large images may fail. Continue anyway?`)) {
    mediaImageUpload.value = '';
    return;
    }
    }

    // Check aspect ratio (warn if unusual)
    const aspectRatio = img.width / img.height;
    if (aspectRatio < 0.5 || aspectRatio > 2) {
    if (!confirm(`Unusual aspect ratio (${img.width}x${img.height}). May not work well. Continue?`)) {
    mediaImageUpload.value = '';
    return;
    }
    }

    uploadedImageData = event.target.result;
    mediaPreviewImg.src = uploadedImageData;
    mediaImagePreview.style.display = 'block';

    // Show image mode selection only for video
    if (selectedMediaType === 'video') {
    imageModeSelection.style.display = 'block';
    }
    };
    img.src = event.target.result;
    };
    reader.onerror = () => {
    alert('Failed to read image file. Please try again.');
    };
    reader.readAsDataURL(file);
    });

    // Clear uploaded image
    mediaClearImage.addEventListener('click', () => {
    uploadedImageData = null;
    mediaImageUpload.value = '';
    mediaImagePreview.style.display = 'none';
    mediaPreviewImg.src = '';
    imageModeSelection.style.display = 'none';
    });

    // Handle audio file upload for music cover
    const uploadFileInput = document.getElementById('upload-file');
    const uploadFileBtn = document.getElementById('upload-file-btn');
    const uploadFileName = document.getElementById('upload-file-name');
    const clearUploadBtn = document.getElementById('clear-upload-btn');

    uploadFileBtn.addEventListener('click', () => {
    uploadFileInput.click();
    });

    uploadFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Check file type
    const validTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/flac', 'audio/x-m4a'];
    const validExtensions = ['.mp3', '.wav', '.m4a', '.ogg', '.flac'];
    const hasValidType = validTypes.includes(file.type) || validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
    
    if (!hasValidType) {
      alert('Invalid audio format. Please use MP3, WAV, M4A, OGG, or FLAC.');
      uploadFileInput.value = '';
      return;
    }

    // Check file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('Audio file is too large. Please use a file under 10MB.');
      uploadFileInput.value = '';
      return;
    }

    // Show uploading status
    uploadFileBtn.disabled = true;
    uploadFileBtn.textContent = 'Uploading...';
    uploadFileName.textContent = 'Uploading file...';

    try {
      // Upload file to server
      const formData = new FormData();
      formData.append('audio', file);

      const response = await fetch('/api/upload-audio', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.details || 'Failed to upload audio file');
      }

      const data = await response.json();
      
      // Store the URL in hidden field
      uploadUrlHidden.value = data.url;
      uploadFileName.textContent = file.name;
      clearUploadBtn.style.display = 'block';
      
    } catch (error) {
      console.error('Upload error:', error);
      alert('Failed to upload audio file: ' + error.message);
      uploadFileInput.value = '';
      uploadUrlHidden.value = '';
      uploadFileName.textContent = 'No file selected';
    } finally {
      uploadFileBtn.disabled = false;
      uploadFileBtn.textContent = 'Choose Audio File';
    }
    });

    clearUploadBtn.addEventListener('click', () => {
    uploadFileInput.value = '';
    uploadUrlHidden.value = '';
    uploadFileName.textContent = 'No file selected';
    clearUploadBtn.style.display = 'none';
    });

    // Helper function to download files properly (bypasses CORS and preview issues)
    async function downloadFile(url, filename) {
    try {
    console.log('Downloading file:', url);
    const response = await fetch(url);
    const blob = await response.blob();
    const blobUrl = window.URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = blobUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Clean up the blob URL after a delay
    setTimeout(() => window.URL.revokeObjectURL(blobUrl), 100);
    console.log('Download initiated for:', filename);
    } catch (error) {
    console.error('Download failed:', error);
    // Fallback to opening in new tab if download fails
    window.open(url, '_blank');
    }
    }

    // Add message to chat
    function addMessage(content, type = 'user') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    messageDiv.innerHTML = `
    <div class="message-label">${type === 'user' ? 'You' : 'AetherWave AI'}</div>
    <div class="message-content">${content}</div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Send message to API
    async function sendMessage(message) {
    if (!message.trim()) return;

    addMessage(message, 'user');
    chatInput.value = '';
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
    const response = await fetch('/api/chat', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({
    message: message,
    provider: 'openai'
    })
    });

    if (!response.ok) {
    throw new Error('Failed to get response');
    }

    const data = await response.json();
    addMessage(data.message, 'assistant');

    } catch (error) {
    console.error('Chat error:', error);
    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
    } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
    }
    }

    // Generate music
    async function generateMusic() {
    const isCustomMode = customModeToggle.checked;
    const model = musicModelHeader.value;
    const instrumental = musicInstrumental.checked;
    const vocalGender = document.getElementById('vocal-gender-value')?.value || 'm';
    const uploadUrl = document.getElementById('upload-url').value.trim();

    console.log('=== Generate Music Called ===');
    console.log('Custom Mode:', isCustomMode);
    console.log('Model:', model);
    console.log('Instrumental:', instrumental);
    console.log('Vocal Gender:', vocalGender);
    console.log('Upload URL:', uploadUrl);

    let requestBody = {
    model: model,
    instrumental: instrumental
    };

    // Add advanced options if available (optional parameters)
    const styleWeight = parseFloat(document.getElementById('style-weight')?.value);
    const weirdnessConstraint = parseFloat(document.getElementById('weirdness-constraint')?.value);
    const audioWeight = parseFloat(document.getElementById('audio-weight')?.value);
    
    if (!isNaN(styleWeight)) requestBody.styleWeight = styleWeight;
    if (!isNaN(weirdnessConstraint)) requestBody.weirdnessConstraint = weirdnessConstraint;
    if (!isNaN(audioWeight)) requestBody.audioWeight = audioWeight;

    if (isCustomMode) {
    // Custom Mode - validation depends on instrumental setting
    const title = musicTitle.value.trim();
    const style = musicStyle.value.trim();
    const lyrics = musicLyrics.value.trim();

    console.log('Custom Mode - Title:', title);
    console.log('Custom Mode - Style:', style);
    console.log('Custom Mode - Lyrics length:', lyrics.length);

    // Title and Style are always required in custom mode
    if (!title || !style) {
    alert('Please provide both Title and Style of Music for Custom Mode');
    return;
    }

    // If NOT instrumental, lyrics (prompt) are required
    if (!instrumental && !lyrics) {
    alert('Please provide Lyrics for Custom Mode (or enable "Make Instrumental")');
    return;
    }

    requestBody.customMode = true;
    requestBody.title = title;
    requestBody.style = style;
    requestBody.prompt = lyrics || ''; // Lyrics required if NOT instrumental
    
    // vocalGender is only effective when customMode is true
    requestBody.vocalGender = vocalGender;
    } else {
    // Non-custom Mode - prompt is always required
    const prompt = musicPromptSimple.value.trim();

    console.log('Non-custom Mode - Prompt:', prompt);

    if (!prompt) {
    alert('Please provide a Song Description');
    return;
    }

    requestBody.customMode = false;
    requestBody.prompt = prompt;
    
    // Note: vocalGender is NOT sent when customMode is false (per API docs)
    }

    // Determine endpoint based on uploadUrl
    let endpoint = '/api/generate-music';
    let actionText = 'Generating Your Music';
    
    if (uploadUrl) {
    endpoint = '/api/upload-cover-music';
    actionText = 'Covering Your Audio';
    requestBody.uploadUrl = uploadUrl;
    }

    generateMusicBtn.disabled = true;
    generateMusicBtn.textContent = 'Generating...';
    musicResult.style.display = 'none';

    try {

    console.log(`Sending request to ${endpoint}:`, requestBody);

    const response = await fetch(endpoint, {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    console.log('Response status:', response.status, response.statusText);

    const data = await response.json();
    console.log('Response data:', data);

    if (!response.ok) {
    // Handle insufficient credits
    if (response.status === 403 && data.error === 'Insufficient credits') {
      showPaymentModal();
      throw new Error(data.message || 'Insufficient credits');
    }
    // Handle other errors
    const errorMsg = data.error || 'Failed to generate music';
    const errorDetails = data.details || '';
    throw new Error(`${errorMsg}${errorDetails ? ': ' + errorDetails : ''}`);
    }
    
    // Refresh credits after successful generation start
    fetchUserCredits();

    // KIE.ai returns a taskId - we need to poll for results
    const musicTaskId = data.taskId;
    
    if (!musicTaskId) {
    throw new Error('No task ID returned from API');
    }

    // Show processing status
    musicResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">🎵 ${actionText}...</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">This usually takes 30-40 seconds for streaming quality.</p>
    <div style="margin-top: 1rem; width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
      <div style="width: 30%; height: 100%; background: var(--aetherwave-purple); animation: pulse 1.5s ease-in-out infinite;"></div>
    </div>
    </div>
    `;
    musicResult.style.display = 'block';

    // Poll for results
    let attempts = 0;
    const maxAttempts = 60; // 2 minutes max (60 * 2 seconds)
    const pollInterval = setInterval(async () => {
      attempts++;
      
      try {
        const statusResponse = await fetch(`/api/music-status/${musicTaskId}`);
        const statusData = await statusResponse.json();
        
        console.log(`Poll attempt ${attempts}:`, statusData);
        
        if (statusData.status === 'SUCCESS' && statusData.tracks && statusData.tracks.length > 0) {
          clearInterval(pollInterval);
          
          // Display all tracks with premium player (usually 2 variations)
          const tracksHTML = statusData.tracks.map((track, index) => `
            <div class="premium-track-card" data-track-id="${track.id}">
              <div class="track-content">
                <div class="track-artwork">
                  <img src="${track.imageUrl || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\'%3E%3Crect fill=\'%238b5cf6\' width=\'80\' height=\'80\'/%3E%3C/svg%3E'}" alt="${track.title || 'Track'}" data-testid="img-track-art-${index}">
                  <div class="track-duration-badge" data-testid="text-duration-${index}">--:--</div>
                </div>
                <div class="track-info">
                  <div class="track-title" data-testid="text-track-title-${index}">${track.title || `Track ${index + 1}`}</div>
                  <div class="track-artist" data-testid="text-track-artist-${index}">AetherWave Studio</div>
                </div>
                <div class="track-controls">
                  <button class="control-btn control-btn-small" onclick="window.premiumPlayer.previous('${track.id}')" title="Previous" data-testid="button-previous-${index}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M11 19l-7-7 7-7M18 19l-7-7 7-7"/>
                    </svg>
                  </button>
                  <button class="control-btn play-pause-btn" onclick="window.premiumPlayer.togglePlay('${track.id}')" data-testid="button-play-${index}">
                    <svg class="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg class="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                      <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                    </svg>
                  </button>
                  <button class="control-btn control-btn-small" onclick="window.premiumPlayer.next('${track.id}')" title="Next" data-testid="button-next-${index}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <path d="M13 19l7-7-7-7M6 19l7-7-7-7"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="track-progress-container">
                <div class="track-progress-bar" onclick="window.premiumPlayer.seek('${track.id}', event)" data-testid="progress-bar-${index}">
                  <div class="track-progress-fill" style="width: 0%"></div>
                </div>
                <div class="track-times">
                  <span class="current-time" data-testid="text-current-time-${index}">0:00</span>
                  <span class="total-time" data-testid="text-total-time-${index}">0:00</span>
                </div>
              </div>
              <div class="track-actions">
                <button class="action-btn" onclick="window.premiumPlayer.openDownloadModal('${track.id}', '${track.title || `Track ${index + 1}`}', '${track.streamAudioUrl || track.audioUrl}')" data-testid="button-download-${index}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                  </svg>
                  Download
                </button>
                <button class="action-btn" onclick="generateVisualForTrack('${musicTaskId}', '${track.id}', '${track.title}', 'image')" data-testid="button-generate-art-${index}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                  </svg>
                  Album Art
                </button>
                <button class="action-btn" onclick="generateVisualForTrack('${musicTaskId}', '${track.id}', '${track.title}', 'video')" data-testid="button-generate-video-${index}">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="23 7 16 12 23 17 23 7"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                  </svg>
                  Music Video
                </button>
              </div>
              <audio preload="metadata" src="${track.streamAudioUrl || track.audioUrl}" data-track-id="${track.id}"></audio>
              <div id="visual-result-${track.id}" style="margin-top: 0.5rem;"></div>
            </div>
          `).join('');

          musicResult.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 0;">
              ${tracksHTML}
            </div>
          `;
          
          // Initialize premium player after tracks are loaded
          setTimeout(() => {
            window.premiumPlayer.init();
          }, 100);
          
          generateMusicBtn.disabled = false;
          generateMusicBtn.textContent = 'Generate Music';
        } else if (attempts >= maxAttempts) {
          clearInterval(pollInterval);
          throw new Error('Generation timeout - please try again');
        }
      } catch (pollError) {
        console.error('Polling error:', pollError);
        clearInterval(pollInterval);
        musicResult.innerHTML = `
          <div class="result-box">
            <div class="result-title">Error</div>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Failed to retrieve music. Please try again.</p>
          </div>
        `;
        generateMusicBtn.disabled = false;
        generateMusicBtn.textContent = 'Generate Music';
      }
    }, 2000); // Poll every 2 seconds

    } catch (error) {
    console.error('Music generation error:', error);
    let errorMessage = 'Unable to generate music. ';

    if (error.message.includes('Failed to fetch')) {
    errorMessage += 'Please check your internet connection.';
    } else if (error.message.includes('CORS')) {
    errorMessage += 'CORS policy error. Check API configuration.';
    } else {
    errorMessage += 'Please try again later.';
    }

    musicResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">${errorMessage}</p>
    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">Error: ${error.message}</p>
    </div>
    `;
    musicResult.style.display = 'block';
    } finally {
    generateMusicBtn.disabled = false;
    generateMusicBtn.textContent = 'Generate Music';
    }
    }

    // Generate album art
    async function generateArt() {
    const prompt = artPrompt.value.trim();
    const style = artStyle.value;

    if (!prompt) {
    alert('Please describe your album art');
    return;
    }

    generateArtBtn.disabled = true;
    generateArtBtn.textContent = 'Generating...';
    artResult.style.display = 'none';

    try {
    const response = await fetch('/api/generate-art', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({
    prompt: prompt,
    style: style
    })
    });

    if (!response.ok) {
    throw new Error('Failed to generate art');
    }

    const data = await response.json();

    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Generated Album Art</div>
    <img src="${data.imageUrl}" alt="Generated album art" class="generated-image" />
    <a href="${data.imageUrl}" download class="download-btn">Download Image</a>
    </div>
    `;
    artResult.style.display = 'block';

    } catch (error) {
    console.error('Art generation error:', error);
    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">Album art generation is coming soon! We're setting up the image AI integration.</p>
    </div>
    `;
    artResult.style.display = 'block';
    } finally {
    generateArtBtn.disabled = false;
    generateArtBtn.textContent = 'Generate Art';
    }
    }

    // Generate video with Seedance
    // Generate Media (Image or Video) with new use case system

async function generateMedia() {
    if (!selectedUseCase) {
        alert('Please select a use case first');
        return;
    }

    const prompt = enhancedPrompt.value.trim();
    if (!prompt) {
        alert('Please provide a prompt');
        return;
    }

    generateMediaBtn.disabled = true;
    const originalBtnText = generateMediaBtn.innerHTML;
    generateMediaBtn.innerHTML = `⏳ Generating ${selectedMediaType}...`;
    mediaResult.style.display = 'none';

    try {
        if (selectedMediaType === 'video') {
            // Video generation with Fal.ai Seedance 1.0
            const requestBody = {
                prompt: prompt,
                modelVersion: mediaQuality.value,
                resolution: mediaResolution.value,
                duration: mediaDuration.value,
                cameraFixed: false,
                enableSafetyChecker: mediaSafetyChecker.checked
            };

            // *** ADD THIS BLOCK HERE ***
            const startImageVal = await handleImageInput(
                document.getElementById('start-image-file'),
                document.getElementById('start-image-url')
            );
            const endImageVal = await handleImageInput(
                document.getElementById('end-image-file'),
                document.getElementById('end-image-url')
            );
            if (startImageVal) requestBody.image_url = startImageVal;
            if (endImageVal) requestBody.end_image_url = endImageVal;

            // Add uploaded image data if provided
            if (uploadedImageData) {
                requestBody.imageData = uploadedImageData;
                requestBody.imageMode = imageMode.value; // 'first-frame' or 'reference'
            }

            console.log('Generating video with Fal.ai Seedance 1.0...');
            const response = await fetch('/api/generate-video-fal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || data.details || 'Failed to generate video');
            }

            // Fal.ai returns video synchronously - display immediately
            if (data.status === 'complete' && data.videoUrl) {
                displayMediaResult(data, 'video');
                return;
            } else {
                throw new Error('Video generated but no URL returned');
            }

        } else {
            // Image generation with OpenAI DALL-E 3
            const requestBody = {
                prompt: prompt,
                style: document.getElementById('media-image-style').value  // Fixed: Pull from dropdown!
            };

            console.log('Generating image with DALL-E 3...');

            const response = await fetch('/api/generate-art', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || data.details || 'Failed to generate image');
            }

            // Display image result
            if (data.imageUrl) {
                mediaResult.innerHTML = `
                    <div class="result-box">
                        <div class="result-title">✅ Image Generated with DALL-E 3</div>
                        <img src="${data.imageUrl}" alt="Generated image" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;" />
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <button onclick="downloadFile('${data.imageUrl}', 'aetherwave-${selectedUseCase}.png')" class="download-btn" style="cursor: pointer;">Download Image</button>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
                            Use Case: ${selectedUseCase} · Style: ${data.style}
                        </p>
                        ${data.revisedPrompt ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">Revised: ${data.revisedPrompt}</p>` : ''}
                    </div>
                `;
                mediaResult.style.display = 'block';
                return;
            } else {
                throw new Error('Image generated but no URL returned');
            }
        }

    } catch (error) {
        console.error('Media generation error:', error);
        mediaResult.innerHTML = `
            <div class="result-box">
                <div class="result-title">Error</div>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Unable to generate ${selectedMediaType}. ${error.message}</p>
            </div>
        `;
        mediaResult.style.display = 'block';
    } finally {
        generateMediaBtn.disabled = false;
        generateMediaBtn.innerHTML = originalBtnText;
    }
}
 
   
 

    // Display media result
    function displayMediaResult(data, type) {
    if (type === 'video') {
    const generationTime = data.timings ? ` (${Math.round(data.timings.inference / 1000)}s)` : '';

    mediaResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">✅ Video Generated with Fal.ai Seedance 1.0${generationTime}</div>
    <video controls autoplay loop src="${data.videoUrl}" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;"></video>
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <a href="${data.videoUrl}" download="aetherwave-${selectedUseCase}.mp4" class="download-btn">Download Video</a>
    ${data.seed ? `<span class="download-btn" style="cursor: default;">Seed: ${data.seed}</span>` : ''}
    </div>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
    Use Case: ${selectedUseCase} · Model: ${data.model || 'Seedance 1.0'}
    </p>
    </div>
    `;
    } else if (type === 'image') {
    mediaResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">✅ Image Generated with DALL-E 3</div>
    <img src="${data.imageUrl}" alt="Generated image" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;" />
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <button onclick="downloadFile('${data.imageUrl}', 'aetherwave-${selectedUseCase}.png')" class="download-btn" style="cursor: pointer;">Download Image</button>
    </div>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
    Use Case: ${selectedUseCase} · Style: ${data.style}
    </p>
    ${data.revisedPrompt ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">DALL-E Revision: ${data.revisedPrompt}</p>` : ''}
    </div>
    `;
    }

    mediaResult.style.display = 'block';
    }

    // Event listener for generate button
    generateMediaBtn.addEventListener('click', generateMedia);

    // OLD VIDEO GENERATION (keep for compatibility with music track buttons)
    async function generateVideo() {
    const prompt = videoPrompt.value.trim();
    const modelVersion = videoModel.value;
    const resolution = videoResolution.value;
    const duration = videoDuration.value;
    const cameraFixed = videoCameraFixed.checked;
    const safetyChecker = videoSafetyChecker.checked;

    if (!prompt) {
    alert('Please describe your video');
    return;
    }

    generateVideoBtn.disabled = true;
    generateVideoBtn.textContent = 'Generating with Seedance...';
    artResult.style.display = 'none';

    try {
    const requestBody = {
    prompt: prompt,
    modelVersion: modelVersion,
    resolution: resolution,
    duration: duration,
    cameraFixed: cameraFixed,
    enableSafetyChecker: safetyChecker
    };

    // Add uploaded image data if provided (for image-to-video)
    if (uploadedImageData) {
    requestBody.imageData = uploadedImageData;
    }

    // Try Fal.ai first (more reliable)
    let response = await fetch('/api/generate-video-fal', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    let data = await response.json();
    let usingFallback = false;

    // If Fal.ai fails, fallback to KIE.AI
    if (!response.ok && data.error?.includes('Fal.ai API key not configured')) {
    console.log('Fal.ai not configured, falling back to KIE.AI...');
    usingFallback = true;

    response = await fetch('/api/generate-video', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    data = await response.json();
    }

    // Handle Fal.ai response (synchronous - video ready immediately)
    if (!usingFallback && response.ok && data.status === 'complete') {
    displayVideoResult(data);
    return;
    }

    // Handle KIE.AI response (async - need to poll)
    if (usingFallback && response.status === 202) {
    // Video generation started - poll for completion
    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">🎬 Generating Video with Seedance 1.0 (KIE.AI)</div>
    <p style="color: var(--accent-color); font-size: 0.9rem;">Video generation started! This may take 5-10 minutes.</p>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">Model: ${data.model || 'Seedance 1.0 Lite'}</p>
    <p style="color: var(--text-muted); font-size: 0.85rem;">Resolution: ${data.resolution || '720p'}</p>
    <p style="color: var(--text-muted); font-size: 0.85rem;">Duration: ${data.duration || '5'}s</p>
    </div>
    `;
    artResult.style.display = 'block';

    // Poll for completion
    pollVideoStatus(data.taskId);
    return;
    }

    if (!response.ok) {
    throw new Error(data.error || data.details || 'Failed to generate video');
    }

    // If video is ready
    if (data.videoUrl) {
    displayVideoResult(data);
    }

    } catch (error) {
    console.error('Video generation error:', error);
    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">Unable to generate video. ${error.message}</p>
    </div>
    `;
    artResult.style.display = 'block';
    } finally {
    generateVideoBtn.disabled = false;
    generateVideoBtn.textContent = 'Generate Video with Seedance 1.0';
    }
    }

    // Removed pollVideoStatus() - no longer needed with Fal.ai synchronous API

    // Display video result
    function displayVideoResult(data) {
    const provider = data.model?.includes('fal-ai') ? 'Fal.ai' : 'KIE.AI';
    const modelName = data.model || 'Seedance 1.0';

    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">✅ Generated Video (${provider})</div>
    <video controls autoplay loop style="width: 100%; border-radius: 8px; margin-bottom: 0.5rem;">
    <source src="${data.videoUrl}" type="video/mp4">
    Your browser does not support the video tag.
    </video>
    ${data.coverUrl ? `<img src="${data.coverUrl}" alt="Video thumbnail" style="display: none;">` : ''}
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <button onclick="downloadFile('${data.videoUrl}', 'seedance-video.mp4')" class="download-btn" style="cursor: pointer;">Download Video</button>
    ${data.seed ? `<span class="download-btn" style="cursor: default;">Seed: ${data.seed}</span>` : ''}
    </div>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">
    ${data.resolution ? `Resolution: ${data.resolution} · ` : ''}
    ${data.duration ? `Duration: ${data.duration}s · ` : ''}
    Model: ${modelName}
    ${data.timings ? ` · Generated in ${Math.round(data.timings.inference / 1000)}s` : ''}
    </p>
    </div>
    `;
    artResult.style.display = 'block';
    }

    // Generate visual (image/video) for a specific track
    window.generateVisualForTrack = async function(musicTaskId, trackId, trackTitle, type) {
    const resultDiv = document.getElementById(`visual-result-${trackId}`);

    // Only ask for prompt for video generation
    let prompt = null;
    if (type === 'video') {
    prompt = window.prompt(
    `Describe the music video for "${trackTitle}"`,
    `Music video for ${trackTitle}`
    );
    if (!prompt) return;
    }

    resultDiv.innerHTML = `<p style="color: var(--text-muted); font-size: 0.9rem;">Generating ${type}...</p>`;

    try {
    if (type === 'video') {
    // Generate music video using Fal.ai Seedance 1.0 (synchronous - no polling!)
    const response = await fetch('/api/generate-video-fal', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
    prompt: prompt,
    modelVersion: 'lite', // Fast generation
    resolution: '720p',
    duration: '5',
    enableSafetyChecker: true
    })
    });

    const data = await response.json();

    console.log('Fal.ai video generation response:', data);

    if (!response.ok) {
    console.error('Video generation error response:', data);
    throw new Error(data.details || data.error || 'Failed to generate video');
    }

    // Fal.ai returns video synchronously - display immediately
    if (data.status === 'complete' && data.videoUrl) {
    resultDiv.innerHTML = `
    <p style="color: #4ade80; font-size: 0.9rem;">✅ Music video complete! (Fal.ai Seedance)</p>
    <video controls autoplay loop style="width: 100%; border-radius: 8px; margin-top: 0.5rem;">
    <source src="${data.videoUrl}" type="video/mp4">
    </video>
    <button onclick="downloadFile('${data.videoUrl}', '${trackTitle}-video.mp4')" class="download-btn" style="margin-top: 0.5rem; cursor: pointer;">Download Video</button>
    `;
    } else if (response.status === 202 || data.status === 'processing') {
    // Fallback for async responses (shouldn't happen with Fal.ai)
    const videoTaskId = data.taskId;

    console.log('Video generation started. Task ID:', videoTaskId);

    resultDiv.innerHTML = `
    <p style="color: var(--accent-color); font-size: 0.9rem;">🎬 Video generation started with Seedance 1.0!</p>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">Task ID: ${videoTaskId}</p>
    <p style="color: var(--text-muted); font-size: 0.8rem;">This may take 5-10 minutes. Checking status every 10 seconds...</p>
    `;

    let pollCount = 0;
    const maxPolls = 60; // 10 minutes max (60 * 10 seconds)

    // Poll for completion
    const checkInterval = setInterval(async () => {
    pollCount++;
    console.log(`Poll attempt ${pollCount}/${maxPolls} for video task: ${videoTaskId}`);

    try {
    const statusResponse = await fetch(`/api/video-status?taskId=${videoTaskId}`);
    console.log('Status response status:', statusResponse.status);

    if (!statusResponse.ok) {
    console.error('Status check failed with status:', statusResponse.status);
    const errorText = await statusResponse.text();
    console.error('Error response:', errorText);
    throw new Error(`Status check failed: ${statusResponse.status} - ${errorText}`);
    }

    const statusData = await statusResponse.json();
    console.log('Status data received:', statusData);

    if (statusData.status === 'complete') {
    clearInterval(checkInterval);
    console.log('Video complete! URL:', statusData.videoUrl);
    resultDiv.innerHTML = `
    <p style="color: #4ade80; font-size: 0.9rem;">✅ Music video complete! (Seedance 1.0)</p>
    <video controls style="width: 100%; border-radius: 8px; margin-top: 0.5rem;">
    <source src="${statusData.videoUrl}" type="video/mp4">
    </video>
    <button onclick="downloadFile('${statusData.videoUrl}', '${trackTitle}-video.mp4')" class="download-btn" style="margin-top: 0.5rem; cursor: pointer;">Download Video</button>
    `;
    } else if (statusData.status === 'failed') {
    clearInterval(checkInterval);
    console.error('Video generation failed:', statusData.error || statusData.details);
    resultDiv.innerHTML = `<p style="color: #ff6b6b; font-size: 0.9rem;">❌ Video generation failed: ${statusData.error || statusData.details || 'Unknown error'}</p>`;
    } else {
    // Still processing - update message with progress
    const progressMsg = statusData.jobStatus || statusData.status || 'processing';
    const elapsedTime = Math.floor((pollCount * 10) / 60);
    const elapsedSeconds = (pollCount * 10) % 60;
    console.log('Still processing. Status:', progressMsg, 'Full status data:', JSON.stringify(statusData));
    resultDiv.innerHTML = `
    <p style="color: var(--accent-color); font-size: 0.9rem;">🎬 Generating music video... (${progressMsg})</p>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">Time elapsed: ${elapsedTime}m ${elapsedSeconds}s</p>
    <p style="color: var(--text-muted); font-size: 0.8rem;">Poll ${pollCount}/${maxPolls} - Task: ${videoTaskId}</p>
    `;
    }

    // Timeout check
    if (pollCount >= maxPolls) {
    clearInterval(checkInterval);
    console.error('Video generation timed out after', maxPolls * 10, 'seconds');
    resultDiv.innerHTML = `
    <p style="color: #ff6b6b; font-size: 0.9rem;">⏱️ Video generation timed out</p>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">The video may still be processing. Task ID: ${videoTaskId}</p>
    <p style="color: var(--text-muted); font-size: 0.8rem;">Check the browser console for more details.</p>
    `;
    }
    } catch (error) {
    console.error('Status check error:', error);
    resultDiv.innerHTML = `
    <p style="color: #ff6b6b; font-size: 0.9rem;">❌ Error checking video status</p>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">${error.message}</p>
    <p style="color: var(--text-muted); font-size: 0.8rem;">Check browser console for details. Task: ${videoTaskId}</p>
    `;
    clearInterval(checkInterval);
    }
    }, 10000); // Check every 10 seconds
    } else if (data.videoUrl) {
    // Video already complete (unlikely)
    resultDiv.innerHTML = `
    <video controls style="width: 100%; border-radius: 8px; margin-top: 0.5rem;">
    <source src="${data.videoUrl}" type="video/mp4">
    </video>
    <button onclick="downloadFile('${data.videoUrl}', '${trackTitle}-video.mp4')" class="download-btn" style="margin-top: 0.5rem; cursor: pointer;">Download Video</button>
    `;
    }
    } else {
    // Generate album art using OpenAI DALL-E 3 (synchronous!)
    resultDiv.innerHTML = `<p style="color: var(--accent-color); font-size: 0.9rem;">🎨 Generating album art with DALL-E 3...</p>`;

    // Get the selected album art style from the dropdown
    const selectedStyle = document.getElementById('album-art-style').value;

    // Create a prompt based on the track title
    const artPrompt = `Album cover art for the song "${trackTitle}". Music-themed, artistic, vibrant, professional album artwork design`;

    console.log('Generating album art with prompt:', artPrompt, 'Style:', selectedStyle);

    const response = await fetch('/api/generate-art', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
    prompt: artPrompt,
    style: selectedStyle // Use the selected style from dropdown
    })
    });

    if (!response.ok) {
    const data = await response.json();
    console.error('Album art generation error:', data);
    throw new Error(data.error || data.details || 'Failed to generate album art');
    }

    const data = await response.json();
    console.log('Album art generated successfully:', data);

    // DALL-E returns image synchronously - display immediately
    if (data.imageUrl) {
    resultDiv.innerHTML = `
    <p style="color: #4ade80; font-size: 0.9rem;">✅ Album art complete! (DALL-E 3)</p>
    <img src="${data.imageUrl}" alt="Album art" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;" />
    <button onclick="downloadFile('${data.imageUrl}', '${trackTitle}-art.png')" class="download-btn" style="margin-top: 0.5rem; cursor: pointer;">Download Image</button>
    ${data.revisedPrompt ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">DALL-E enhanced: ${data.revisedPrompt}</p>` : ''}
    `;
    } else {
    throw new Error('Album art generated but no image URL returned');
    }
    }
    } catch (error) {
    console.error(`${type} generation error:`, error);
    resultDiv.innerHTML = `<p style="color: #ff6b6b; font-size: 0.9rem;">Error: ${error.message}</p>`;
    }
    };

    // Event listeners - Chat
    sendBtn.addEventListener('click', () => {
    sendMessage(chatInput.value);
    });

    chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
    sendMessage(chatInput.value);
    }
    });

    suggestionChips.forEach(chip => {
    chip.addEventListener('click', () => {
    chatInput.value = chip.textContent;
    sendMessage(chip.textContent);
    });
    });

    // Event listeners - Music
    generateMusicBtn.addEventListener('click', generateMusic);

    // Event listeners - Visual (Art/Video)
    generateArtBtn.addEventListener('click', generateArt);
    generateVideoBtn.addEventListener('click', generateVideo);
        
         // --- Place this block last ---
 

function updateMediaInputs() {
  if (selectedMediaType === "video") {
    document.getElementById('start-image-group').style.display = 'block';
    document.getElementById('end-image-group').style.display = 'block';
    document.getElementById('image-upload-group').style.display = 'none';
  } else {
    document.getElementById('start-image-group').style.display = 'none';
    document.getElementById('end-image-group').style.display = 'none';
    document.getElementById('image-upload-group').style.display = 'block';
  }
}

mediaTypeBtns.forEach(btn => {
  btn.addEventListener('click', function() {
    mediaTypeBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedMediaType = btn.dataset.type;
    updateMediaInputs();
  });
});

// **Force correct UI and variable state immediately after setup**
updateMediaInputs();
  </script>
  <!-- Download Modal -->
  <div id="download-modal" class="modal-overlay" style="display: none;" data-testid="modal-download" onclick="if(event.target === this) window.premiumPlayer.closeDownloadModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Download Track</div>
        <div class="modal-subtitle" id="modal-track-title">Select your preferred format</div>
      </div>
      <div class="download-options">
        <div class="download-option" onclick="window.premiumPlayer.selectFormat('mp3')" data-testid="option-mp3">
          <div class="download-option-info">
            <div class="download-option-title">MP3 (Recommended)</div>
            <div class="download-option-desc">Universal format, works everywhere</div>
          </div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="download-option" onclick="window.premiumPlayer.selectFormat('wav')" data-testid="option-wav">
          <div class="download-option-info">
            <div class="download-option-title">WAV (Lossless)</div>
            <div class="download-option-desc">Uncompressed audio, larger file size</div>
          </div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" onclick="window.premiumPlayer.closeDownloadModal()" data-testid="button-modal-cancel">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="window.premiumPlayer.confirmDownload()" data-testid="button-modal-download">Download</button>
      </div>
    </div>
  </div>

</body>
</html>