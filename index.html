<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AetherWave Studio - All Intelligence is Welcome Here</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
   /*:root {
    --aetherwave-pink: #ff2ea6;
    --aetherwave-purple: #8b5cf6;
    --dark-bg: #0d0b15;
    --card-bg: #1a1625;
    --text-primary: #e9e8ff;
    --text-muted: #b7b3d9;
    --border-color: #2d2640;
    } */
        :root {
    --aetherwave-pink: #ff2ea6;
    --aetherwave-purple: #8b5cf6;
    --dark-bg: #0d0b15;
    --card-bg: #1a1625;
    --text-primary: #e9e8ff;
    --text-muted: #b7b3d9;
    --border-color: #2d2640;
    }


    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--dark-bg);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    }

    /* Animated Background */
    .bg-container {
    position: fixed;
    inset: 0;
    z-index: 0;
    overflow: hidden;
    background: radial-gradient(ellipse at 20% 30%, rgba(139, 92, 246, 0.15), transparent 50%),
    radial-gradient(ellipse at 80% 70%, rgba(255, 46, 166, 0.12), transparent 50%);
    }

    .bg-grid {
    position: absolute;
    inset: 0;
    background-image:
    linear-gradient(var(--border-color) 1px, transparent 1px),
    linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.3;
    animation: gridMove 20s linear infinite;
    }

    @keyframes gridMove {
    0% { transform: translate(0, 0); }
    100% { transform: translate(60px, 60px); }
    }

    .orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.4;
    animation: float 15s ease-in-out infinite;
    }

    .orb-1 {
    width: 400px;
    height: 400px;
    background: var(--aetherwave-pink);
    top: 10%;
    left: 10%;
    animation-delay: 0s;
    }

    .orb-2 {
    width: 300px;
    height: 300px;
    background: var(--aetherwave-purple);
    bottom: 20%;
    right: 15%;
    animation-delay: 5s;
    }

    @keyframes float {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -30px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    /* Header */
    header {
    position: relative;
    z-index: 10;
    padding: .5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
    backdrop-filter: blur(12px);
    background: rgba(13, 11, 21, 0.8);
    }

    .logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
    }

    .logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    }
        .logo-icon2 {
    width: 75px;
    height: 75px;
    /*background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));*/
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    }

    nav {
    display: flex;
    gap: 2rem;
    align-items: center;
    }

    nav a {
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.95rem;
    transition: color 0.2s;
    }

    nav a:hover {
    color: var(--text-primary);
    }

    .nav-btn {
    padding: 0.5rem 1.25rem;
    background: var(--aetherwave-pink);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    }

    .nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(255, 46, 166, 0.4);
    }

    /* Main Content */
    main {
    position: relative;
    z-index: 1;
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1rem 2rem 2rem;
    max-width: 1600px;
    margin: 0 auto;
    width: 100%;
    min-height: 0;
    gap: 1.5rem;
    }

    .panels-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1.5rem;
    flex: 1;
    min-height: 0;
    }

    .hero-text {
    text-align: center;
    animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
    from {
    opacity: 0;
    transform: translateY(20px);
    }
    to {
    opacity: 1;
    transform: translateY(0);
    }
    }

    h1 {
    font-size: clamp(1.75rem, 3vw, 2.25rem);
    font-weight: 700;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple), var(--text-primary));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
    }

    .subtitle {
    font-size: 0.95rem;
    color: var(--text-muted);
    max-width: 600px;
    margin: 0 auto;
    }

    /* Panel Styling */
    .panel {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    animation: fadeInUp 0.8s ease-out 0.2s backwards;
    display: flex;
    flex-direction: column;
    }

    .panel-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: rgba(13, 11, 21, 0.5);
    }

    .panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    }

    .panel-description {
    font-size: 0.85rem;
    color: var(--text-muted);
    }

    .panel-content {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    }

    /* Chat Interface */
    .chat-messages {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    }

    .message {
    animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
    }

    .message-label {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-muted);
    }

    .message-content {
    padding: 1rem 1.25rem;
    border-radius: 12px;
    line-height: 1.6;
    }

    .message.user .message-content {
    background: rgba(255, 46, 166, 0.1);
    border: 1px solid rgba(255, 46, 166, 0.3);
    margin-left: 2rem;
    }

    .message.assistant .message-content {
    background: rgba(139, 92, 246, 0.08);
    border: 1px solid var(--border-color);
    }

    .chat-input-area {
    padding: 1rem;
    border-top: 1px solid var(--border-color);
    background: rgba(13, 11, 21, 0.5);
    }

    /* Music Generation */
    .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    }

    .form-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
    }

    textarea {
    padding: 0.75rem 1rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.9rem;
    font-family: inherit;
    outline: none;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s;
    }

    textarea:focus {
    border-color: var(--aetherwave-pink);
    }

    select {
    padding: 0.75rem 1rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 0.9rem;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
    }

    select:focus {
    border-color: var(--aetherwave-pink);
    }

    .btn-primary {
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    font-size: 0.95rem;
    }

    .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 46, 166, 0.4);
    }

    .btn-primary:active {
    transform: translateY(0);
    }

    .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    }

    .result-box {
    padding: 1rem;
    background: rgba(139, 92, 246, 0.08);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    margin-top: 0.5rem;
    }

    .result-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    }

    audio {
    width: 100%;
    margin-bottom: 0.5rem;
    }

    .generated-image {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    }

    .download-btn {
    padding: 0.5rem 1rem;
    background: rgba(139, 92, 246, 0.2);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    }

    .download-btn:hover {
    background: rgba(139, 92, 246, 0.3);
    border-color: var(--aetherwave-purple);
    }

    .input-wrapper {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    }

    input[type="text"] {
    flex: 1;
    padding: 0.875rem 1.25rem;
    background: var(--dark-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 0.95rem;
    outline: none;
    transition: border-color 0.2s;
    }

    input[type="text"]:focus {
    border-color: var(--aetherwave-pink);
    }

    input[type="text"]::placeholder {
    color: var(--text-muted);
    }

    .send-btn {
    padding: 0.875rem 1.5rem;
    background: linear-gradient(135deg, var(--aetherwave-pink), var(--aetherwave-purple));
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    }

    .send-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 46, 166, 0.4);
    }

    .send-btn:active {
    transform: translateY(0);
    }

    /* Suggested Prompts */
    .suggestions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
    }

    .suggestion-chip {
    padding: 0.4rem 0.75rem;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    font-size: 0.75rem;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    }

    .suggestion-chip:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: var(--aetherwave-purple);
    color: var(--text-primary);
    }

    /* Use Case Cards */
    .use-case-card {
    position: relative;
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem 0.75rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: visible;
    }

    .use-case-card:hover {
    border-color: var(--aetherwave-purple);
    background: rgba(139, 92, 246, 0.1);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
    }

    .use-case-card.selected {
    border-color: var(--aetherwave-pink);
    background: rgba(255, 46, 166, 0.1);
    box-shadow: 0 4px 16px rgba(255, 46, 166, 0.3);
    }

    .use-case-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    filter: grayscale(0.3);
    transition: filter 0.3s ease;
    }

    .use-case-card:hover .use-case-icon {
    filter: grayscale(0);
    transform: scale(1.1);
    }

    .use-case-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.3;
    }

    /* Tooltip Lightbox */
    .use-case-tooltip {
    position: absolute;
    bottom: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: rgba(26, 22, 37, 0.98);
    border: 1px solid var(--aetherwave-purple);
    border-radius: 12px;
    padding: 1rem;
    width: 280px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 100;
    backdrop-filter: blur(12px);
    }

    .use-case-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: var(--aetherwave-purple);
    }

    .use-case-card:hover .use-case-tooltip {
    opacity: 1;
    transform: translateX(-50%) scale(1);
    pointer-events: auto;
    }

    .use-case-tooltip strong {
    display: block;
    color: var(--aetherwave-pink);
    font-size: 1rem;
    margin-bottom: 0.5rem;
    }

    .use-case-tooltip p {
    font-size: 0.85rem;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 0.5rem;
    }

    .use-case-tooltip em {
    display: block;
    font-size: 0.75rem;
    color: var(--aetherwave-purple);
    font-style: italic;
    line-height: 1.4;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
    }

    /* Media Type Toggle Buttons */
    .media-type-btn:hover {
    transform: translateY(-2px);
    }

    .media-type-btn.active {
    background: var(--aetherwave-pink) !important;
    border-color: var(--aetherwave-pink) !important;
    color: white !important;
    box-shadow: 0 4px 16px rgba(255, 46, 166, 0.4);
    }

    @media (max-width: 1200px) {
    .panels-container {
    grid-template-columns: 1fr;
    gap: 1rem;
    }

    main {
    padding: 1rem;
    }
    }

    @media (max-width: 768px) {
    header {
    padding: 1rem;
    }

    nav {
    gap: 1rem;
    }

    nav a:not(.nav-btn) {
    display: none;
    }

    h1 {
    font-size: 1.5rem;
    }

    .subtitle {
    font-size: 0.9rem;
    }

    .message.user .message-content {
    margin-left: 0;
    }

    .panel-content {
    padding: 1rem;
    }
    }
  </style>
</head>
<body>
  <div class="bg-container">
    <div class="bg-grid"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
  </div>

  <header>
    <a href="/" class="logo">
    <div class="logo-icon2"><img class="logo-icon2" src='.\assets\Logo-SilverAlloy-Loop-1.gif'></div>
    <span><img width='300px' height='50px' src='.\assets\aws-logo.png'></span>
    </a>
    <nav>
    <a href="https://ai-hub.aetherwavestudio.com">AI Hub</a>
    <a href="/playlists/">Playlists</a>
    <a href="/featured-artist/">Featured Artist</a>
    <a href="/virtual-artists/">Virtual Artists</a>
    <a href="/shop/">Shop</a>
    <div id="auth-section" style="display: flex; align-items: center; gap: 1rem;">
      <a href="/api/login" class="nav-btn" id="login-btn" data-testid="button-login">Login</a>
      <div id="user-profile" style="display: none; align-items: center; gap: 0.75rem;">
        <img id="user-avatar" src="" alt="" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--aetherwave-purple);">
        <span id="user-name" style="color: var(--text-primary); font-size: 0.9rem;" data-testid="text-username"></span>
        <a href="/api/logout" class="nav-btn" style="padding: 0.5rem 1rem; font-size: 0.85rem;" data-testid="button-logout">Logout</a>
      </div>
    </div>
    </nav>
  </header>

  <main>
    <div class="hero-text">
    <h1>AI Music and Media Center</h1>
    <p class="subtitle">Create music, chat with AI, and generate album art - all in one creative studio</p>
    </div>

    <div class="panels-container">
    <!-- Music Generation Panel -->
    <div class="panel">
    <div class="panel-header">
    <div class="panel-title">üéµ Music Generation</div>
    <div class="panel-description">Create AI-generated music with SUNO</div>
    </div>
    <div class="panel-content">
    <!-- Custom Mode Toggle -->
    <div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
    <input type="checkbox" id="custom-mode-toggle" style="width: auto; cursor: pointer;">
    <span class="form-label" style="margin: 0;">Custom Mode</span>
    </label>
    </div>

    <!-- Simple Mode Fields -->
    <div id="simple-mode-fields">
    <div class="form-group">
    <label class="form-label">Song Description <span id="simple-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/199)</span></label>
    <textarea id="music-prompt-simple" maxlength="199" placeholder="Describe the style of music and the topic you want, AI will generate lyrics for you"></textarea>
    </div>
    </div>

    <!-- Custom Mode Fields -->
    <div id="custom-mode-fields" style="display: none;">
    <div class="form-group">
    <label class="form-label">Title</label>
    <input type="text" id="music-title" placeholder="Song title" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
    </div>
    <div class="form-group">
    <label class="form-label">Style of Music</label>
    <input type="text" id="music-style" placeholder="e.g., ethereal, funk, dreamy, anthemic" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
    </div>
    <div class="form-group">
    <label class="form-label">Lyrics <span id="custom-char-count" style="color: var(--text-muted); font-size: 0.85rem;">(0/3000)</span></label>
    <textarea id="music-lyrics" maxlength="3000" placeholder="Write your own lyrics, two verses (8 lines) for the best result" style="min-height: 120px;"></textarea>
    </div>
    </div>

<div id="advanced-options" style="display: none;">
  <details open>
    <summary style="cursor:pointer; font-weight:600; color:var(--aetherwave-purple); margin-bottom:1rem;">
      Advanced Options
    </summary>
    <div class="form-group">
      <label class="form-label">Vocal Gender Preference:</label>
      <input type="radio" id="vocal-gender-m" name="vocalGender" value="m" aria-label="male" checked>
      <label for="vocal-gender-m">Male</label>
      <input type="radio" id="vocal-gender-f" name="vocalGender" value="f" style="margin-left:1rem;" aria-label="female">
      <label for="vocal-gender-f">Female</label>
    </div>
    <div class="form-group">
      <label for="style-weight" class="form-label">
        Style Weight (0‚Äì1):
      </label>
      <input type="range" id="style-weight" min="0" max="1" step="0.01" value="0.65">
      <span id="style-weight-value">0.65</span>
    </div>
    <div class="form-group">
      <label for="weirdness-constraint" class="form-label">
        Weirdness Constraint (0‚Äì1):
      </label>
      <input type="range" id="weirdness-constraint" min="0" max="1" step="0.01" value="0.65">
      <span id="weirdness-constraint-value">0.65</span>
    </div>
    <div class="form-group">
      <label for="audio-weight" class="form-label">
        Audio Weight (0‚Äì1):
      </label>
      <input type="range" id="audio-weight" min="0" max="1" step="0.01" value="0.65">
      <span id="audio-weight-value">0.65</span>
    </div>
  </details>
</div>

    <!-- Model Version (Always visible) -->
    <div class="form-group">
    <label class="form-label">Model Version</label>
    <select id="music-model">
    <option value="V5">V5 (Latest - Fastest)</option>
    <option value="V4_5PLUS">V4.5+ (Enhanced)</option>
    <option value="V4_5">V4.5</option>
    <option value="V4">V4</option>
    <option value="V3_5">V3.5</option>
    </select>
    </div>

    <!-- Make Instrumental Toggle -->
    <div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
    <input type="checkbox" id="music-instrumental" style="width: auto; cursor: pointer;">
    <span class="form-label" style="margin: 0;">Make Instrumental</span>
    </label>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; margin-left: 1.5rem;">Create a song without lyrics</div>
    </div>

    <!-- Album Art Style Selector -->
    <!-- Wrap this dropdown in a container div -->
        <div id="album-art-style-container" style="display:none;">
        <label class="form-label">Album Art Style for auto-generated art</label>
        <select id="album-art-style">
    <option value="photorealistic" selected>Photorealistic</option>
    <option value="abstract">Abstract</option>
    <option value="cyberpunk">Cyberpunk</option>
    <option value="retro">Retro</option>
    <option value="minimal">Minimal</option>
    <option value="surreal">Surreal</option>
    <option value="cinematic">Cinematic</option>
    <option value="artistic">Artistic</option>
        </select>
        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
    Choose the visual style for Album Art
  </div>
</div>

    <button class="btn-primary" id="generate-music-btn">Generate Music</button>
    <div id="music-result" style="display: none;"></div>
    </div>
    </div>

    <!-- Chat Panel -->
    <div class="panel">
    <div class="panel-header">
    <div class="panel-title">üí¨ AetherWave AI</div>
    <div class="panel-description">Your creative companion</div>
    </div>
    <div class="panel-content">
    <div class="chat-messages">
    <div class="message assistant">
    <div class="message-label">AetherWave AI</div>
    <div class="message-content">
    Hello! I can help you create music, generate album art, or answer questions about AetherWave Studio. What would you like to create today?
    </div>
    </div>
    </div>
    </div>
    <div class="chat-input-area">
    <div class="input-wrapper">
    <input type="text" id="chat-input" placeholder="Ask me anything..." />
    <button class="send-btn" id="send-btn">Send</button>
    </div>
    <div class="suggestions">
    <div class="suggestion-chip">Prompts for Music</div>
    <div class="suggestion-chip">Lyric Generation</div>
    <div class="suggestion-chip">Album Art tips</div>
    </div>
    </div>
    </div>

    <!-- Visual Generation Panel -->
    <div class="panel">
    <div class="panel-header">
    <div class="panel-title">üé¨ AI Media Generator</div>
    <div class="panel-description">Create images and videos for your music career</div>
    </div>
    <div class="panel-content">

    <!-- Step 1: Media Type Selection -->
    <div id="media-type-selection">
    <div class="form-group">
    <label class="form-label">What do you want to create?</label>
    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
    <button class="media-type-btn active" data-type="image" style="flex: 1; padding: 1rem; background: var(--accent-color); border: 2px solid var(--accent-color); border-radius: 12px; color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;">
    üì∏ Image
    </button>
    <button class="media-type-btn" data-type="video" style="flex: 1; padding: 1rem; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s;">
    üé• Video
    </button>
    </div>
    </div>
    </div>

    <!-- Step 2: Use Case Selection -->
    <div id="use-case-selection" style="margin-top: 1.5rem;">
    <div class="form-group">
    <label class="form-label">Choose your use case</label>
    <div class="use-case-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-top: 0.5rem;">

    <!-- Band Profile Card -->
    <div class="use-case-card" data-use-case="band-profile">
    <div class="use-case-icon">üë§</div>
    <div class="use-case-name">Band Profile</div>
    <div class="use-case-tooltip">
    <strong>Band Profile</strong>
    <p>Professional artist photos for press kits, social media profiles, and promotional materials</p>
    <em>Example: "Indie rock band posing in urban alley with vintage instruments"</em>
    </div>
    </div>

    <!-- Live Photos Card -->
    <div class="use-case-card" data-use-case="live-photos">
    <div class="use-case-icon">üé∏</div>
    <div class="use-case-name">Live Photos</div>
    <div class="use-case-tooltip">
    <strong>Live Photos</strong>
    <p>Dynamic concert and performance shots with energy and atmosphere</p>
    <em>Example: "Singer performing on stage with dramatic lighting and crowd"</em>
    </div>
    </div>

    <!-- Live Video Card -->
    <div class="use-case-card" data-use-case="live-video">
    <div class="use-case-icon">üé§</div>
    <div class="use-case-name">Live Video</div>
    <div class="use-case-tooltip">
    <strong>Live Video</strong>
    <p>Concert footage and performance clips for social media and promotion</p>
    <em>Example: "Guitarist shredding solo with flashing stage lights"</em>
    </div>
    </div>

    <!-- Production Video Card -->
    <div class="use-case-card" data-use-case="production-video">
    <div class="use-case-icon">üé¨</div>
    <div class="use-case-name">Production Video</div>
    <div class="use-case-tooltip">
    <strong>Production Video</strong>
    <p>Professional music videos with cinematic quality and storytelling</p>
    <em>Example: "Cinematic shots of artist walking through neon-lit city"</em>
    </div>
    </div>

    <!-- Backstage Pass Card -->
    <div class="use-case-card" data-use-case="backstage">
    <div class="use-case-icon">üé≠</div>
    <div class="use-case-name">Backstage Pass</div>
    <div class="use-case-tooltip">
    <strong>Backstage Pass</strong>
    <p>Behind-the-scenes content showing the artist life and creative process</p>
    <em>Example: "Band members relaxing in green room with instruments"</em>
    </div>
    </div>

    <!-- On The Road Card -->
    <div class="use-case-card" data-use-case="on-the-road">
    <div class="use-case-icon">üöê</div>
    <div class="use-case-name">On The Road</div>
    <div class="use-case-tooltip">
    <strong>On The Road</strong>
    <p>Tour life, travel scenes, and adventure content for storytelling</p>
    <em>Example: "Tour bus driving through desert landscape at sunset"</em>
    </div>
    </div>

    <!-- Album Art Card -->
    <div class="use-case-card" data-use-case="album-art">
    <div class="use-case-icon">üíø</div>
    <div class="use-case-name">Album Art</div>
    <div class="use-case-tooltip">
    <strong>Album Art</strong>
    <p>Square format cover art for singles, EPs, and full albums</p>
    <em>Example: "Abstract geometric shapes in vibrant neon colors"</em>
    </div>
    </div>

    <!-- News Reports Card -->
    <div class="use-case-card" data-use-case="news-reports">
    <div class="use-case-icon">üì∞</div>
    <div class="use-case-name">News Reports</div>
    <div class="use-case-tooltip">
    <strong>News Reports</strong>
    <p>Press-style imagery and announcement visuals for releases and events</p>
    <em>Example: "Breaking news style graphic with artist announcement"</em>
    </div>
    </div>

    </div>
    </div>
    </div>

    <!-- Step 3: Generation Settings (shown after use case selected) -->
    <div id="generation-settings" style="display: none; margin-top: 1.5rem;">

    <!-- Enhanced Prompt Preview -->
    <div class="form-group">
    <label class="form-label">AI Prompt (edit to customize)</label>
    <textarea id="enhanced-prompt" rows="4" placeholder="Your enhanced prompt will appear here..." style="font-family: monospace; font-size: 0.9rem;"></textarea>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">This is the full prompt sent to the AI. Feel free to edit it!</div>
    </div>

    <!-- User's Creative Input -->
    <div class="form-group">
    <label class="form-label">Your Vision (optional - add custom details)</label>
    <textarea id="user-vision" rows="2" placeholder="e.g., wearing leather jacket, vintage 80s aesthetic, purple color scheme..."></textarea>
    </div>

    <!-- Image Upload (Optional) -->
<div class="form-group" id="image-upload-group">
  <label class="form-label">
    <span>Upload Image (Optional)</span>
    <span style="font-size: 0.8rem; color: var(--text-muted); font-weight: normal; margin-left: 0.5rem;">- Upload reference image here</span>
  </label>
  <input type="file" id="media-image-upload" accept="image/*" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer;">
</div>

<!-- Start Image (First Frame) Uploader -->
<div class="form-group" id="start-image-group" style="display:none;">
  <label class="form-label">Start Frame (Image or URL)</label>
  <input type="file" id="start-image-file" accept="image/*" style="margin-bottom:0.5rem;">
  <input type="text" id="start-image-url" placeholder="or paste image URL" style="width:100%;">
</div>

<!-- End Image (Last Frame) Uploader -->
<div class="form-group" id="end-image-group" style="display:none;">
  <label class="form-label">End Frame (Image or URL)</label>
  <input type="file" id="end-image-file" accept="image/*" style="margin-bottom:0.5rem;">
  <input type="text" id="end-image-url" placeholder="or paste image URL" style="width:100%;">
</div>



    <!-- Image Mode Selection (shown only for video when image uploaded) -->
    <div id="image-mode-selection" style="display: none; margin-top: 0.75rem;">
    <label class="form-label">How should the image be used?</label>
    <select id="image-mode" style="width: 100%; padding: 0.75rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 0.9rem;">
    <option value="first-frame">First Frame - Start video with this image</option>
    <option value="reference">Style Reference - Use as visual inspiration (1-4 images)</option>
    </select>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
    <strong>First Frame:</strong> Image becomes the opening frame, AI animates from there<br>
    <strong>Reference:</strong> AI uses image(s) as style guide but creates new content
    </div>
    

    <div id="media-image-preview" style="display: none; margin-top: 0.5rem;">
    <img id="media-preview-img" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid var(--border-color);" />
    <button type="button" id="media-clear-image" class="download-btn" style="margin-top: 0.5rem; display: inline-block;">Clear Image</button>
    </div>
    </div>

    <!-- Image Style Selector (only for images, not videos) -->
    <div class="form-group" id="image-style-group" style="display: block;">
    <label class="form-label">Image Style</label>
    <select id="media-image-style">
    <option value="photorealistic">Photorealistic</option>
    <option value="abstract">Abstract</option>
    <option value="cyberpunk">Cyberpunk</option>
    <option value="retro">Retro</option>
    <option value="minimal">Minimal</option>
    <option value="surreal">Surreal</option>
    <option value="cinematic">Cinematic</option>
    <option value="artistic">Artistic</option>
    </select>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">Choose the visual style for your generated image</div>
    </div>

    <!-- Advanced Settings (collapsible) -->
    <div class="form-group">
    <details>
    <summary style="cursor: pointer; font-weight: 600; color: var(--accent-color); margin-bottom: 1rem;">‚öôÔ∏è Advanced Settings</summary>

    <div class="form-group" id="video-settings-group" style="display: none;">
    <label class="form-label">Quality</label>
    <select id="media-quality">
    <option value="lite" selected>Fast (Lite Model)</option>
    <option value="pro">High Quality (Pro Model)</option>
    </select>
    </div>

    <div class="form-group" id="video-resolution-group" style="display: none;">
    <label class="form-label">Resolution</label>
    <select id="media-resolution">
    <option value="512p">512p (Fastest, Lower Quality)</option>
    <option value="720p" selected>720p (Balanced)</option>
    <option value="1080p">1080p (Highest Quality, Slower)</option>
    </select>
    </div>

    <div class="form-group" id="video-duration-group" style="display: none;">
    <label class="form-label">Duration</label>
    <select id="media-duration">
    <option value="5" selected>5 seconds</option>
    <option value="10">10 seconds</option>
    </select>
    </div>

    <div class="form-group">
    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
    <input type="checkbox" id="media-safety-checker" checked style="width: auto; cursor: pointer;">
    <span class="form-label" style="margin: 0;">Enable Safety Checker</span>
    </label>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; margin-left: 1.5rem;">Uncheck if getting false rejections</div>
    </div>
    </details>
    </div>

    <!-- Generate Button -->
    <button class="btn-primary" id="generate-media-btn" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600;">
    üé® Generate <span id="media-type-label">Image</span>
    </button>

    <!-- Back Button -->
    <button class="download-btn" id="back-to-use-cases" style="width: 100%; margin-top: 0.5rem;">
    ‚Üê Back to Use Cases
    </button>
    </div>

    <!-- Results Display -->
    <div id="media-result" style="display: none; margin-top: 1.5rem;"></div>
    </div>
    </div>
    </div>
  </main>

  <script>
    // Error handling wrapper
    window.addEventListener('error', (e) => {
    console.error('Global error:', e.message, e.filename, e.lineno, e.colno);
    });

    // Check authentication status and update UI
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/user');
        if (response.ok) {
          const user = await response.json();
          // User is logged in
          document.getElementById('login-btn').style.display = 'none';
          document.getElementById('user-profile').style.display = 'flex';
          document.getElementById('user-name').textContent = user.firstName || user.email || 'User';
          if (user.profileImageUrl) {
            document.getElementById('user-avatar').src = user.profileImageUrl;
            document.getElementById('user-avatar').alt = user.firstName || 'User';
          } else {
            // Use a default avatar if no profile image
            document.getElementById('user-avatar').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238b5cf6"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
            document.getElementById('user-avatar').alt = user.email || 'User';
          }
          
          // Load user's vocal gender preference
          if (user.vocalGenderPreference) {
            const radio = document.querySelector(`input[name="vocalGender"][value="${user.vocalGenderPreference}"]`);
            if (radio) radio.checked = true;
          }
        } else {
          // User not logged in
          document.getElementById('login-btn').style.display = 'inline-block';
          document.getElementById('user-profile').style.display = 'none';
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        // Show login button on error
        document.getElementById('login-btn').style.display = 'inline-block';
        document.getElementById('user-profile').style.display = 'none';
      }
    }

    // Check auth on page load
    checkAuth();

        const mediaTypeBtns = document.querySelectorAll('.media-type-btn');
        let selectedMediaType = document.querySelector('.media-type-btn.active').dataset.type;

// ...rest of your code, using mediaTypeBtns...


    // Chat functionality
    const chatMessages = document.querySelector('.chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const suggestionChips = document.querySelectorAll('.suggestion-chip');

    // Music generation - Elements
    const customModeToggle = document.getElementById('custom-mode-toggle');
    const simpleModeFields = document.getElementById('simple-mode-fields');
    const customModeFields = document.getElementById('custom-mode-fields');
    const musicPromptSimple = document.getElementById('music-prompt-simple');
    const musicTitle = document.getElementById('music-title');
    const musicStyle = document.getElementById('music-style');
    const musicLyrics = document.getElementById('music-lyrics');
    const musicModel = document.getElementById('music-model');
    const musicInstrumental = document.getElementById('music-instrumental');
    const generateMusicBtn = document.getElementById('generate-music-btn');
    const musicResult = document.getElementById('music-result');
    const simpleCharCount = document.getElementById('simple-char-count');
    const customCharCount = document.getElementById('custom-char-count');



        // Place this near other helper functions or at top, after DOM ready
        async function handleImageInput(fileInput, urlInput) {
        const file = fileInput.files[0];
        if (file) {
    return new Promise((resolve, reject) => {
     const reader = new FileReader();
     reader.onload = e => resolve(e.target.result);
     reader.onerror = e => reject(e);
     reader.readAsDataURL(file);
    });
  }
  // If no file, but URL provided
  if (urlInput.value && urlInput.value.trim() !== '') {
    return urlInput.value.trim();
  }
  return null;
}

    // Custom Mode Toggle
    customModeToggle.addEventListener('change', () => {
    if (customModeToggle.checked) {
    simpleModeFields.style.display = 'none';
    customModeFields.style.display = 'block';
    } else {
    simpleModeFields.style.display = 'block';
    customModeFields.style.display = 'none';
    }
    });
        
const advancedOptions = document.getElementById('advanced-options');

// Show/hide Advanced Options based on custom mode
customModeToggle.addEventListener('change', function() {
  if (customModeToggle.checked) {
    advancedOptions.style.display = 'block';
  } else {
    advancedOptions.style.display = 'none';
  }
});



// Also set initial visibility at page load:
if (customModeToggle.checked) {
  advancedOptions.style.display = 'block';
} else {
  advancedOptions.style.display = 'none';
}

// Slider live value update logic
['style-weight', 'weirdness-constraint', 'audio-weight'].forEach(function(id) {
  const slider = document.getElementById(id);
  const output = document.getElementById(id + '-value');
  slider.addEventListener('input', function() {
    output.textContent = slider.value;
  });
});


    // Character counter for Simple Mode
    musicPromptSimple.addEventListener('input', () => {
    const charCount = musicPromptSimple.value.length;
    simpleCharCount.textContent = `(${charCount}/199)`;
    });

    // Character counter for Custom Mode Lyrics
    musicLyrics.addEventListener('input', () => {
    const charCount = musicLyrics.value.length;
    customCharCount.textContent = `(${charCount}/3000)`;
    });

    // NEW Visual Generation System - Use Case Based
    //const mediaTypeBtns = document.querySelectorAll('.media-type-btn');
    const useCaseCards = document.querySelectorAll('.use-case-card');
    const generationSettings = document.getElementById('generation-settings');
    const enhancedPrompt = document.getElementById('enhanced-prompt');
    const userVision = document.getElementById('user-vision');
    const mediaImageUpload = document.getElementById('media-image-upload');
    const mediaImagePreview = document.getElementById('media-image-preview');
    const mediaPreviewImg = document.getElementById('media-preview-img');
    const mediaClearImage = document.getElementById('media-clear-image');
    const imageModeSelection = document.getElementById('image-mode-selection');
    const imageMode = document.getElementById('image-mode');
    const mediaQuality = document.getElementById('media-quality');
    const mediaResolution = document.getElementById('media-resolution');
    const mediaDuration = document.getElementById('media-duration');
    const mediaSafetyChecker = document.getElementById('media-safety-checker');
    const generateMediaBtn = document.getElementById('generate-media-btn');
    const mediaTypeLabel = document.getElementById('media-type-label');
    const backToUseCases = document.getElementById('back-to-use-cases');
    const mediaResult = document.getElementById('media-result');
    const videoSettingsGroup = document.getElementById('video-settings-group');
    const videoResolutionGroup = document.getElementById('video-resolution-group');
    const videoDurationGroup = document.getElementById('video-duration-group');
    const imageStyleGroup = document.getElementById('image-style-group');
    const mediaImageStyle = document.getElementById('media-image-style');

    // State management'
    let selectedUseCase = null;
    let uploadedImageData = null;





    // Prompt templates for each use case
    const promptTemplates = {
    'band-profile': {
    image: 'Professional artist portrait photography: {vision}. Studio lighting, high quality, detailed, press kit worthy, promotional photo style.',
    video: 'Cinematic portrait footage: {vision}. Professional lighting, slow camera movement, artist posing confidently, high production value.'
    },
    'live-photos': {
    image: 'Live concert photography: {vision}. Dynamic stage lighting, energetic performance, crowd atmosphere, professional music photography.',
    video: 'Live performance footage: {vision}. Concert stage with dramatic lighting, energetic movement, crowd energy, professional concert videography.'
    },
    'live-video': {
    image: 'Concert performance shot: {vision}. Stage lights, live music energy, performance intensity, concert photography.',
    video: 'Live concert performance: {vision}. Dynamic camera angles, stage lighting effects, musician performing live, concert film quality.'
    },
    'production-video': {
    image: 'Cinematic music video still: {vision}. Professional cinematography, artistic composition, music video aesthetic, high production value.',
    video: 'Professional music video production: {vision}. Cinematic camera work, artistic storytelling, high-quality cinematography, music video style.'
    },
    'backstage': {
    image: 'Behind-the-scenes music photography: {vision}. Candid backstage moments, authentic artist life, documentary photography style.',
    video: 'Backstage documentary footage: {vision}. Behind-the-scenes access, authentic moments, candid artist interactions, documentary style.'
    },
    'on-the-road': {
    image: 'Tour life photography: {vision}. Travel documentary style, authentic road moments, touring musician lifestyle, candid shots.',
    video: 'Tour documentary footage: {vision}. Travel scenes, road life, touring musician journey, documentary cinematography.'
    },
    'album-art': {
    image: 'Album cover art design: {vision}. Square format, artistic composition, professional album artwork, high-quality graphic design.',
    video: 'Animated album artwork: {vision}. Square format, artistic motion graphics, professional album art animation, looping visual.'
    },
    'news-reports': {
    image: 'Music news press image: {vision}. Professional news photography, press release quality, announcement graphic style.',
    video: 'Music news announcement video: {vision}. News report style, professional presentation, press announcement format.'
    }
    };

    
        // When Generate Album Art button is clicked, show the dropdown.
        document.addEventListener('click', function(e) {
        if (e.target && e.target.matches('.download-btn[onclick*="Generate Album Art"]')) {
    document.getElementById('album-art-style-container').style.display = 'block';
    document.getElementById('album-art-style').value = 'photorealistic';
                }
        });

        // Media type toggle
    mediaTypeBtns.forEach(btn => {
    btn.addEventListener('click', () => {
    mediaTypeBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedMediaType = btn.dataset.type;
    mediaTypeLabel.textContent = selectedMediaType === 'image' ? 'Image' : 'Video';
        
        

    // Show/hide video-specific settings and image-specific settings
    if (selectedMediaType === 'video') {
    videoSettingsGroup.style.display = 'block';
    videoResolutionGroup.style.display = 'block';
    videoDurationGroup.style.display = 'block';
    imageStyleGroup.style.display = 'none'; // Hide image style for video
    } else {
    videoSettingsGroup.style.display = 'none';
    videoResolutionGroup.style.display = 'none';
    videoDurationGroup.style.display = 'none';
    imageStyleGroup.style.display = 'block'; // Show image style for image
    }
        // Call updateMediaInputs whenever media type is toggled
        mediaTypeBtns.forEach(btn => {
        btn.addEventListener('click', updateMediaInputs);
        });
    // Update enhanced prompt if use case already selected
    if (selectedUseCase) {
    updateEnhancedPrompt();
    }
    });
    });

    // Use case selection
    useCaseCards.forEach(card => {
    card.addEventListener('click', () => {
    useCaseCards.forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedUseCase = card.dataset.useCase;



    // Show generation settings
    generationSettings.style.display = 'block';

    // Update enhanced prompt
    updateEnhancedPrompt();

    // Scroll to settings
    setTimeout(() => {
    generationSettings.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
    });
    });

    // Update enhanced prompt based on use case and user vision
    function updateEnhancedPrompt() {
    if (!selectedUseCase) return;

    const template = promptTemplates[selectedUseCase][selectedMediaType];
    const vision = userVision.value.trim() || 'artist/band';
    const finalPrompt = template.replace('{vision}', vision);

    enhancedPrompt.value = finalPrompt;
    }

    // User vision input updates prompt
    userVision.addEventListener('input', updateEnhancedPrompt);

    // Back button
    backToUseCases.addEventListener('click', () => {
    generationSettings.style.display = 'none';
    useCaseCards.forEach(c => c.classList.remove('selected'));
    selectedUseCase = null;
    enhancedPrompt.value = '';
    userVision.value = '';
    mediaResult.style.display = 'none';
    });

    // Handle image upload for media generator
    mediaImageUpload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Check file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
    if (!validTypes.includes(file.type)) {
    alert('Invalid image format. Please use JPG, PNG, WEBP, or GIF.');
    mediaImageUpload.value = '';
    return;
    }

    // Check file size (max 5MB for better compatibility)
    if (file.size > 5 * 1024 * 1024) {
    alert('Image file is too large. Please use an image under 5MB.');
    mediaImageUpload.value = '';
    return;
    }

    // Read file as base64 and validate dimensions
    const reader = new FileReader();
    reader.onload = (event) => {
    const img = new Image();
    img.onload = () => {
    // Check dimensions (recommend 720p or less for best results)
    const maxDimension = 1920;
    if (img.width > maxDimension || img.height > maxDimension) {
    if (!confirm(`Image is ${img.width}x${img.height}. Large images may fail. Continue anyway?`)) {
    mediaImageUpload.value = '';
    return;
    }
    }

    // Check aspect ratio (warn if unusual)
    const aspectRatio = img.width / img.height;
    if (aspectRatio < 0.5 || aspectRatio > 2) {
    if (!confirm(`Unusual aspect ratio (${img.width}x${img.height}). May not work well. Continue?`)) {
    mediaImageUpload.value = '';
    return;
    }
    }

    uploadedImageData = event.target.result;
    mediaPreviewImg.src = uploadedImageData;
    mediaImagePreview.style.display = 'block';

    // Show image mode selection only for video
    if (selectedMediaType === 'video') {
    imageModeSelection.style.display = 'block';
    }
    };
    img.src = event.target.result;
    };
    reader.onerror = () => {
    alert('Failed to read image file. Please try again.');
    };
    reader.readAsDataURL(file);
    });

    // Clear uploaded image
    mediaClearImage.addEventListener('click', () => {
    uploadedImageData = null;
    mediaImageUpload.value = '';
    mediaImagePreview.style.display = 'none';
    mediaPreviewImg.src = '';
    imageModeSelection.style.display = 'none';
    });

    // Helper function to download files properly (bypasses CORS and preview issues)
    async function downloadFile(url, filename) {
    try {
    console.log('Downloading file:', url);
    const response = await fetch(url);
    const blob = await response.blob();
    const blobUrl = window.URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = blobUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Clean up the blob URL after a delay
    setTimeout(() => window.URL.revokeObjectURL(blobUrl), 100);
    console.log('Download initiated for:', filename);
    } catch (error) {
    console.error('Download failed:', error);
    // Fallback to opening in new tab if download fails
    window.open(url, '_blank');
    }
    }

    // Add message to chat
    function addMessage(content, type = 'user') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    messageDiv.innerHTML = `
    <div class="message-label">${type === 'user' ? 'You' : 'AetherWave AI'}</div>
    <div class="message-content">${content}</div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Send message to API
    async function sendMessage(message) {
    if (!message.trim()) return;

    addMessage(message, 'user');
    chatInput.value = '';
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    try {
    const response = await fetch('/api/chat', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({
    message: message,
    provider: 'openai'
    })
    });

    if (!response.ok) {
    throw new Error('Failed to get response');
    }

    const data = await response.json();
    addMessage(data.message, 'assistant');

    } catch (error) {
    console.error('Chat error:', error);
    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
    } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = 'Send';
    }
    }

    // Generate music
    async function generateMusic() {
    const isCustomMode = customModeToggle.checked;
    const model = musicModel.value;
    const instrumental = musicInstrumental.checked;
    const vocalGender = document.querySelector('input[name="vocalGender"]:checked')?.value || 'm';

    console.log('=== Generate Music Called ===');
    console.log('Custom Mode:', isCustomMode);
    console.log('Model:', model);
    console.log('Instrumental:', instrumental);
    console.log('Vocal Gender:', vocalGender);

    let requestBody = {
    model: model,
    instrumental: instrumental,
    vocalGender: vocalGender
    };

    if (isCustomMode) {
    // Custom Mode - requires title, style, and lyrics
    const title = musicTitle.value.trim();
    const style = musicStyle.value.trim();
    const lyrics = musicLyrics.value.trim();

    console.log('Custom Mode - Title:', title);
    console.log('Custom Mode - Style:', style);
    console.log('Custom Mode - Lyrics length:', lyrics.length);

    if (!title || !style) {
    alert('Please provide both Title and Style of Music for Custom Mode');
    return;
    }

    requestBody.customMode = true;
    requestBody.title = title;
    requestBody.style = style;
    requestBody.prompt = lyrics || ''; // Lyrics can be optional
    } else {
    // Simple Mode - requires prompt
    const prompt = musicPromptSimple.value.trim();

    console.log('Simple Mode - Prompt:', prompt);

    if (!prompt) {
    alert('Please describe your song');
    return;
    }


    requestBody.customMode = false;
    requestBody.prompt = prompt;
    }

    generateMusicBtn.disabled = true;
    generateMusicBtn.textContent = 'Generating...';
    musicResult.style.display = 'none';

    try {

    console.log('Sending request to /api/generate-music:', requestBody);

    const response = await fetch('/api/generate-music', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    console.log('Response status:', response.status, response.statusText);

    const data = await response.json();
    console.log('Response data:', data);

    if (!response.ok) {
    const errorMsg = data.error || 'Failed to generate music';
    const errorDetails = data.details || '';
    throw new Error(`${errorMsg}${errorDetails ? ': ' + errorDetails : ''}`);
    }

    // KIE.ai returns a taskId - we need to poll for results
    const musicTaskId = data.taskId;
    
    if (!musicTaskId) {
    throw new Error('No task ID returned from API');
    }

    // Show processing status
    musicResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">üéµ Generating Your Music...</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">This usually takes 30-40 seconds for streaming quality.</p>
    <div style="margin-top: 1rem; width: 100%; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden;">
      <div style="width: 30%; height: 100%; background: var(--aetherwave-purple); animation: pulse 1.5s ease-in-out infinite;"></div>
    </div>
    </div>
    `;
    musicResult.style.display = 'block';

    // Poll for results
    let attempts = 0;
    const maxAttempts = 60; // 2 minutes max (60 * 2 seconds)
    const pollInterval = setInterval(async () => {
      attempts++;
      
      try {
        const statusResponse = await fetch(`/api/music-status/${musicTaskId}`);
        const statusData = await statusResponse.json();
        
        console.log(`Poll attempt ${attempts}:`, statusData);
        
        if (statusData.status === 'SUCCESS' && statusData.tracks && statusData.tracks.length > 0) {
          clearInterval(pollInterval);
          
          // Display all tracks (usually 2 variations)
          const tracksHTML = statusData.tracks.map((track, index) => `
            <div class="result-box" style="margin-bottom: 1rem;">
              <div class="result-title">${track.title || `Track ${index + 1}`}</div>
              <audio controls src="${track.streamAudioUrl || track.audioUrl}"></audio>
              ${track.imageUrl ? `<img src="${track.imageUrl}" alt="Album art" style="width: 100%; border-radius: 8px; margin: 0.5rem 0;" />` : ''}
              <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                <a href="${track.streamAudioUrl || track.audioUrl}" download="${track.title || 'music'}.mp3" class="download-btn">Download MP3</a>
                <button class="download-btn" onclick="generateVisualForTrack('${musicTaskId}', '${track.id}', '${track.title}', 'image')" style="cursor: pointer;">Generate Album Art</button>
                <button class="download-btn" onclick="generateVisualForTrack('${musicTaskId}', '${track.id}', '${track.title}', 'video')" style="cursor: pointer;">Generate Music Video</button>
              </div>
              <div id="visual-result-${track.id}" style="margin-top: 0.5rem;"></div>
            </div>
          `).join('');

          musicResult.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              ${tracksHTML}
            </div>
          `;
          
          generateMusicBtn.disabled = false;
          generateMusicBtn.textContent = 'Generate Music';
        } else if (attempts >= maxAttempts) {
          clearInterval(pollInterval);
          throw new Error('Generation timeout - please try again');
        }
      } catch (pollError) {
        console.error('Polling error:', pollError);
        clearInterval(pollInterval);
        musicResult.innerHTML = `
          <div class="result-box">
            <div class="result-title">Error</div>
            <p style="color: var(--text-muted); font-size: 0.9rem;">Failed to retrieve music. Please try again.</p>
          </div>
        `;
        generateMusicBtn.disabled = false;
        generateMusicBtn.textContent = 'Generate Music';
      }
    }, 2000); // Poll every 2 seconds

    } catch (error) {
    console.error('Music generation error:', error);
    let errorMessage = 'Unable to generate music. ';

    if (error.message.includes('Failed to fetch')) {
    errorMessage += 'Please check your internet connection.';
    } else if (error.message.includes('CORS')) {
    errorMessage += 'CORS policy error. Check API configuration.';
    } else {
    errorMessage += 'Please try again later.';
    }

    musicResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">${errorMessage}</p>
    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">Error: ${error.message}</p>
    </div>
    `;
    musicResult.style.display = 'block';
    } finally {
    generateMusicBtn.disabled = false;
    generateMusicBtn.textContent = 'Generate Music';
    }
    }

    // Generate album art
    async function generateArt() {
    const prompt = artPrompt.value.trim();
    const style = artStyle.value;

    if (!prompt) {
    alert('Please describe your album art');
    return;
    }

    generateArtBtn.disabled = true;
    generateArtBtn.textContent = 'Generating...';
    artResult.style.display = 'none';

    try {
    const response = await fetch('/api/generate-art', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify({
    prompt: prompt,
    style: style
    })
    });

    if (!response.ok) {
    throw new Error('Failed to generate art');
    }

    const data = await response.json();

    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Generated Album Art</div>
    <img src="${data.imageUrl}" alt="Generated album art" class="generated-image" />
    <a href="${data.imageUrl}" download class="download-btn">Download Image</a>
    </div>
    `;
    artResult.style.display = 'block';

    } catch (error) {
    console.error('Art generation error:', error);
    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">Album art generation is coming soon! We're setting up the image AI integration.</p>
    </div>
    `;
    artResult.style.display = 'block';
    } finally {
    generateArtBtn.disabled = false;
    generateArtBtn.textContent = 'Generate Art';
    }
    }

    // Generate video with Seedance
    // Generate Media (Image or Video) with new use case system

async function generateMedia() {
    if (!selectedUseCase) {
        alert('Please select a use case first');
        return;
    }

    const prompt = enhancedPrompt.value.trim();
    if (!prompt) {
        alert('Please provide a prompt');
        return;
    }

    generateMediaBtn.disabled = true;
    const originalBtnText = generateMediaBtn.innerHTML;
    generateMediaBtn.innerHTML = `‚è≥ Generating ${selectedMediaType}...`;
    mediaResult.style.display = 'none';

    try {
        if (selectedMediaType === 'video') {
            // Video generation with Fal.ai Seedance 1.0
            const requestBody = {
                prompt: prompt,
                modelVersion: mediaQuality.value,
                resolution: mediaResolution.value,
                duration: mediaDuration.value,
                cameraFixed: false,
                enableSafetyChecker: mediaSafetyChecker.checked
            };

            // *** ADD THIS BLOCK HERE ***
            const startImageVal = await handleImageInput(
                document.getElementById('start-image-file'),
                document.getElementById('start-image-url')
            );
            const endImageVal = await handleImageInput(
                document.getElementById('end-image-file'),
                document.getElementById('end-image-url')
            );
            if (startImageVal) requestBody.image_url = startImageVal;
            if (endImageVal) requestBody.end_image_url = endImageVal;

            // Add uploaded image data if provided
            if (uploadedImageData) {
                requestBody.imageData = uploadedImageData;
                requestBody.imageMode = imageMode.value; // 'first-frame' or 'reference'
            }

            console.log('Generating video with Fal.ai Seedance 1.0...');
            const response = await fetch('/api/generate-video-fal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || data.details || 'Failed to generate video');
            }

            // Fal.ai returns video synchronously - display immediately
            if (data.status === 'complete' && data.videoUrl) {
                displayMediaResult(data, 'video');
                return;
            } else {
                throw new Error('Video generated but no URL returned');
            }

        } else {
            // Image generation with OpenAI DALL-E 3
            const requestBody = {
                prompt: prompt,
                style: document.getElementById('media-image-style').value  // Fixed: Pull from dropdown!
            };

            console.log('Generating image with DALL-E 3...');

            const response = await fetch('/api/generate-art', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || data.details || 'Failed to generate image');
            }

            // Display image result
            if (data.imageUrl) {
                mediaResult.innerHTML = `
                    <div class="result-box">
                        <div class="result-title">‚úÖ Image Generated with DALL-E 3</div>
                        <img src="${data.imageUrl}" alt="Generated image" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;" />
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <button onclick="downloadFile('${data.imageUrl}', 'aetherwave-${selectedUseCase}.png')" class="download-btn" style="cursor: pointer;">Download Image</button>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
                            Use Case: ${selectedUseCase} ¬∑ Style: ${data.style}
                        </p>
                        ${data.revisedPrompt ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">Revised: ${data.revisedPrompt}</p>` : ''}
                    </div>
                `;
                mediaResult.style.display = 'block';
                return;
            } else {
                throw new Error('Image generated but no URL returned');
            }
        }

    } catch (error) {
        console.error('Media generation error:', error);
        mediaResult.innerHTML = `
            <div class="result-box">
                <div class="result-title">Error</div>
                <p style="color: var(--text-muted); font-size: 0.9rem;">Unable to generate ${selectedMediaType}. ${error.message}</p>
            </div>
        `;
        mediaResult.style.display = 'block';
    } finally {
        generateMediaBtn.disabled = false;
        generateMediaBtn.innerHTML = originalBtnText;
    }
}
 
   
 

    // Display media result
    function displayMediaResult(data, type) {
    if (type === 'video') {
    const generationTime = data.timings ? ` (${Math.round(data.timings.inference / 1000)}s)` : '';

    mediaResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">‚úÖ Video Generated with Fal.ai Seedance 1.0${generationTime}</div>
    <video controls autoplay loop src="${data.videoUrl}" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;"></video>
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <a href="${data.videoUrl}" download="aetherwave-${selectedUseCase}.mp4" class="download-btn">Download Video</a>
    ${data.seed ? `<span class="download-btn" style="cursor: default;">Seed: ${data.seed}</span>` : ''}
    </div>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
    Use Case: ${selectedUseCase} ¬∑ Model: ${data.model || 'Seedance 1.0'}
    </p>
    </div>
    `;
    } else if (type === 'image') {
    mediaResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">‚úÖ Image Generated with DALL-E 3</div>
    <img src="${data.imageUrl}" alt="Generated image" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;" />
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <button onclick="downloadFile('${data.imageUrl}', 'aetherwave-${selectedUseCase}.png')" class="download-btn" style="cursor: pointer;">Download Image</button>
    </div>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">
    Use Case: ${selectedUseCase} ¬∑ Style: ${data.style}
    </p>
    ${data.revisedPrompt ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">DALL-E Revision: ${data.revisedPrompt}</p>` : ''}
    </div>
    `;
    }

    mediaResult.style.display = 'block';
    }

    // Event listener for generate button
    generateMediaBtn.addEventListener('click', generateMedia);

    // OLD VIDEO GENERATION (keep for compatibility with music track buttons)
    async function generateVideo() {
    const prompt = videoPrompt.value.trim();
    const modelVersion = videoModel.value;
    const resolution = videoResolution.value;
    const duration = videoDuration.value;
    const cameraFixed = videoCameraFixed.checked;
    const safetyChecker = videoSafetyChecker.checked;

    if (!prompt) {
    alert('Please describe your video');
    return;
    }

    generateVideoBtn.disabled = true;
    generateVideoBtn.textContent = 'Generating with Seedance...';
    artResult.style.display = 'none';

    try {
    const requestBody = {
    prompt: prompt,
    modelVersion: modelVersion,
    resolution: resolution,
    duration: duration,
    cameraFixed: cameraFixed,
    enableSafetyChecker: safetyChecker
    };

    // Add uploaded image data if provided (for image-to-video)
    if (uploadedImageData) {
    requestBody.imageData = uploadedImageData;
    }

    // Try Fal.ai first (more reliable)
    let response = await fetch('/api/generate-video-fal', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    let data = await response.json();
    let usingFallback = false;

    // If Fal.ai fails, fallback to KIE.AI
    if (!response.ok && data.error?.includes('Fal.ai API key not configured')) {
    console.log('Fal.ai not configured, falling back to KIE.AI...');
    usingFallback = true;

    response = await fetch('/api/generate-video', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json'
    },
    body: JSON.stringify(requestBody)
    });

    data = await response.json();
    }

    // Handle Fal.ai response (synchronous - video ready immediately)
    if (!usingFallback && response.ok && data.status === 'complete') {
    displayVideoResult(data);
    return;
    }

    // Handle KIE.AI response (async - need to poll)
    if (usingFallback && response.status === 202) {
    // Video generation started - poll for completion
    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">üé¨ Generating Video with Seedance 1.0 (KIE.AI)</div>
    <p style="color: var(--accent-color); font-size: 0.9rem;">Video generation started! This may take 5-10 minutes.</p>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem;">Model: ${data.model || 'Seedance 1.0 Lite'}</p>
    <p style="color: var(--text-muted); font-size: 0.85rem;">Resolution: ${data.resolution || '720p'}</p>
    <p style="color: var(--text-muted); font-size: 0.85rem;">Duration: ${data.duration || '5'}s</p>
    </div>
    `;
    artResult.style.display = 'block';

    // Poll for completion
    pollVideoStatus(data.taskId);
    return;
    }

    if (!response.ok) {
    throw new Error(data.error || data.details || 'Failed to generate video');
    }

    // If video is ready
    if (data.videoUrl) {
    displayVideoResult(data);
    }

    } catch (error) {
    console.error('Video generation error:', error);
    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">Error</div>
    <p style="color: var(--text-muted); font-size: 0.9rem;">Unable to generate video. ${error.message}</p>
    </div>
    `;
    artResult.style.display = 'block';
    } finally {
    generateVideoBtn.disabled = false;
    generateVideoBtn.textContent = 'Generate Video with Seedance 1.0';
    }
    }

    // Removed pollVideoStatus() - no longer needed with Fal.ai synchronous API

    // Display video result
    function displayVideoResult(data) {
    const provider = data.model?.includes('fal-ai') ? 'Fal.ai' : 'KIE.AI';
    const modelName = data.model || 'Seedance 1.0';

    artResult.innerHTML = `
    <div class="result-box">
    <div class="result-title">‚úÖ Generated Video (${provider})</div>
    <video controls autoplay loop style="width: 100%; border-radius: 8px; margin-bottom: 0.5rem;">
    <source src="${data.videoUrl}" type="video/mp4">
    Your browser does not support the video tag.
    </video>
    ${data.coverUrl ? `<img src="${data.coverUrl}" alt="Video thumbnail" style="display: none;">` : ''}
    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <button onclick="downloadFile('${data.videoUrl}', 'seedance-video.mp4')" class="download-btn" style="cursor: pointer;">Download Video</button>
    ${data.seed ? `<span class="download-btn" style="cursor: default;">Seed: ${data.seed}</span>` : ''}
    </div>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">
    ${data.resolution ? `Resolution: ${data.resolution} ¬∑ ` : ''}
    ${data.duration ? `Duration: ${data.duration}s ¬∑ ` : ''}
    Model: ${modelName}
    ${data.timings ? ` ¬∑ Generated in ${Math.round(data.timings.inference / 1000)}s` : ''}
    </p>
    </div>
    `;
    artResult.style.display = 'block';
    }

    // Generate visual (image/video) for a specific track
    window.generateVisualForTrack = async function(musicTaskId, trackId, trackTitle, type) {
    const resultDiv = document.getElementById(`visual-result-${trackId}`);

    // Only ask for prompt for video generation
    let prompt = null;
    if (type === 'video') {
    prompt = window.prompt(
    `Describe the music video for "${trackTitle}"`,
    `Music video for ${trackTitle}`
    );
    if (!prompt) return;
    }

    resultDiv.innerHTML = `<p style="color: var(--text-muted); font-size: 0.9rem;">Generating ${type}...</p>`;

    try {
    if (type === 'video') {
    // Generate music video using Fal.ai Seedance 1.0 (synchronous - no polling!)
    const response = await fetch('/api/generate-video-fal', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
    prompt: prompt,
    modelVersion: 'lite', // Fast generation
    resolution: '720p',
    duration: '5',
    enableSafetyChecker: true
    })
    });

    const data = await response.json();

    console.log('Fal.ai video generation response:', data);

    if (!response.ok) {
    console.error('Video generation error response:', data);
    throw new Error(data.details || data.error || 'Failed to generate video');
    }

    // Fal.ai returns video synchronously - display immediately
    if (data.status === 'complete' && data.videoUrl) {
    resultDiv.innerHTML = `
    <p style="color: #4ade80; font-size: 0.9rem;">‚úÖ Music video complete! (Fal.ai Seedance)</p>
    <video controls autoplay loop style="width: 100%; border-radius: 8px; margin-top: 0.5rem;">
    <source src="${data.videoUrl}" type="video/mp4">
    </video>
    <button onclick="downloadFile('${data.videoUrl}', '${trackTitle}-video.mp4')" class="download-btn" style="margin-top: 0.5rem; cursor: pointer;">Download Video</button>
    `;
    } else if (response.status === 202 || data.status === 'processing') {
    // Fallback for async responses (shouldn't happen with Fal.ai)
    const videoTaskId = data.taskId;

    console.log('Video generation started. Task ID:', videoTaskId);

    resultDiv.innerHTML = `
    <p style="color: var(--accent-color); font-size: 0.9rem;">üé¨ Video generation started with Seedance 1.0!</p>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">Task ID: ${videoTaskId}</p>
    <p style="color: var(--text-muted); font-size: 0.8rem;">This may take 5-10 minutes. Checking status every 10 seconds...</p>
    `;

    let pollCount = 0;
    const maxPolls = 60; // 10 minutes max (60 * 10 seconds)

    // Poll for completion
    const checkInterval = setInterval(async () => {
    pollCount++;
    console.log(`Poll attempt ${pollCount}/${maxPolls} for video task: ${videoTaskId}`);

    try {
    const statusResponse = await fetch(`/api/video-status?taskId=${videoTaskId}`);
    console.log('Status response status:', statusResponse.status);

    if (!statusResponse.ok) {
    console.error('Status check failed with status:', statusResponse.status);
    const errorText = await statusResponse.text();
    console.error('Error response:', errorText);
    throw new Error(`Status check failed: ${statusResponse.status} - ${errorText}`);
    }

    const statusData = await statusResponse.json();
    console.log('Status data received:', statusData);

    if (statusData.status === 'complete') {
    clearInterval(checkInterval);
    console.log('Video complete! URL:', statusData.videoUrl);
    resultDiv.innerHTML = `
    <p style="color: #4ade80; font-size: 0.9rem;">‚úÖ Music video complete! (Seedance 1.0)</p>
    <video controls style="width: 100%; border-radius: 8px; margin-top: 0.5rem;">
    <source src="${statusData.videoUrl}" type="video/mp4">
    </video>
    <button onclick="downloadFile('${statusData.videoUrl}', '${trackTitle}-video.mp4')" class="download-btn" style="margin-top: 0.5rem; cursor: pointer;">Download Video</button>
    `;
    } else if (statusData.status === 'failed') {
    clearInterval(checkInterval);
    console.error('Video generation failed:', statusData.error || statusData.details);
    resultDiv.innerHTML = `<p style="color: #ff6b6b; font-size: 0.9rem;">‚ùå Video generation failed: ${statusData.error || statusData.details || 'Unknown error'}</p>`;
    } else {
    // Still processing - update message with progress
    const progressMsg = statusData.jobStatus || statusData.status || 'processing';
    const elapsedTime = Math.floor((pollCount * 10) / 60);
    const elapsedSeconds = (pollCount * 10) % 60;
    console.log('Still processing. Status:', progressMsg, 'Full status data:', JSON.stringify(statusData));
    resultDiv.innerHTML = `
    <p style="color: var(--accent-color); font-size: 0.9rem;">üé¨ Generating music video... (${progressMsg})</p>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">Time elapsed: ${elapsedTime}m ${elapsedSeconds}s</p>
    <p style="color: var(--text-muted); font-size: 0.8rem;">Poll ${pollCount}/${maxPolls} - Task: ${videoTaskId}</p>
    `;
    }

    // Timeout check
    if (pollCount >= maxPolls) {
    clearInterval(checkInterval);
    console.error('Video generation timed out after', maxPolls * 10, 'seconds');
    resultDiv.innerHTML = `
    <p style="color: #ff6b6b; font-size: 0.9rem;">‚è±Ô∏è Video generation timed out</p>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">The video may still be processing. Task ID: ${videoTaskId}</p>
    <p style="color: var(--text-muted); font-size: 0.8rem;">Check the browser console for more details.</p>
    `;
    }
    } catch (error) {
    console.error('Status check error:', error);
    resultDiv.innerHTML = `
    <p style="color: #ff6b6b; font-size: 0.9rem;">‚ùå Error checking video status</p>
    <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">${error.message}</p>
    <p style="color: var(--text-muted); font-size: 0.8rem;">Check browser console for details. Task: ${videoTaskId}</p>
    `;
    clearInterval(checkInterval);
    }
    }, 10000); // Check every 10 seconds
    } else if (data.videoUrl) {
    // Video already complete (unlikely)
    resultDiv.innerHTML = `
    <video controls style="width: 100%; border-radius: 8px; margin-top: 0.5rem;">
    <source src="${data.videoUrl}" type="video/mp4">
    </video>
    <button onclick="downloadFile('${data.videoUrl}', '${trackTitle}-video.mp4')" class="download-btn" style="margin-top: 0.5rem; cursor: pointer;">Download Video</button>
    `;
    }
    } else {
    // Generate album art using OpenAI DALL-E 3 (synchronous!)
    resultDiv.innerHTML = `<p style="color: var(--accent-color); font-size: 0.9rem;">üé® Generating album art with DALL-E 3...</p>`;

    // Get the selected album art style from the dropdown
    const selectedStyle = document.getElementById('album-art-style').value;

    // Create a prompt based on the track title
    const artPrompt = `Album cover art for the song "${trackTitle}". Music-themed, artistic, vibrant, professional album artwork design`;

    console.log('Generating album art with prompt:', artPrompt, 'Style:', selectedStyle);

    const response = await fetch('/api/generate-art', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
    prompt: artPrompt,
    style: selectedStyle // Use the selected style from dropdown
    })
    });

    if (!response.ok) {
    const data = await response.json();
    console.error('Album art generation error:', data);
    throw new Error(data.error || data.details || 'Failed to generate album art');
    }

    const data = await response.json();
    console.log('Album art generated successfully:', data);

    // DALL-E returns image synchronously - display immediately
    if (data.imageUrl) {
    resultDiv.innerHTML = `
    <p style="color: #4ade80; font-size: 0.9rem;">‚úÖ Album art complete! (DALL-E 3)</p>
    <img src="${data.imageUrl}" alt="Album art" style="width: 100%; border-radius: 8px; margin-top: 0.5rem;" />
    <button onclick="downloadFile('${data.imageUrl}', '${trackTitle}-art.png')" class="download-btn" style="margin-top: 0.5rem; cursor: pointer;">Download Image</button>
    ${data.revisedPrompt ? `<p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">DALL-E enhanced: ${data.revisedPrompt}</p>` : ''}
    `;
    } else {
    throw new Error('Album art generated but no image URL returned');
    }
    }
    } catch (error) {
    console.error(`${type} generation error:`, error);
    resultDiv.innerHTML = `<p style="color: #ff6b6b; font-size: 0.9rem;">Error: ${error.message}</p>`;
    }
    };

    // Event listeners - Chat
    sendBtn.addEventListener('click', () => {
    sendMessage(chatInput.value);
    });

    chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
    sendMessage(chatInput.value);
    }
    });

    suggestionChips.forEach(chip => {
    chip.addEventListener('click', () => {
    chatInput.value = chip.textContent;
    sendMessage(chip.textContent);
    });
    });

    // Event listeners - Music
    generateMusicBtn.addEventListener('click', generateMusic);

    // Event listeners - Visual (Art/Video)
    generateArtBtn.addEventListener('click', generateArt);
    generateVideoBtn.addEventListener('click', generateVideo);
        
         // --- Place this block last ---
 

function updateMediaInputs() {
  if (selectedMediaType === "video") {
    document.getElementById('start-image-group').style.display = 'block';
    document.getElementById('end-image-group').style.display = 'block';
    document.getElementById('image-upload-group').style.display = 'none';
  } else {
    document.getElementById('start-image-group').style.display = 'none';
    document.getElementById('end-image-group').style.display = 'none';
    document.getElementById('image-upload-group').style.display = 'block';
  }
}

mediaTypeBtns.forEach(btn => {
  btn.addEventListener('click', function() {
    mediaTypeBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedMediaType = btn.dataset.type;
    updateMediaInputs();
  });
});

// **Force correct UI and variable state immediately after setup**
updateMediaInputs();
  </script>
</body>
</html>